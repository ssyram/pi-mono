# è¾©é¢˜ 2: å²å®˜ç”Ÿå‘½å‘¨æœŸä¸è§¦å‘æ—¶æœº
# Topic 2: Historian Lifecycle

> æ—¥æœŸ: 2026-02-23
> å‚ä¸æ¨¡å‹: kimi-k2.5, claude-sonnet-4-6, gpt-5.2, qwen3.5-plus
> è¯„å®¡æ¨¡å‹: qwen3.5-plus

---

## ç¬¬ä¸€è½®ï¼šåˆå§‹ç«‹åœº

### Party A â€” åˆå§‹ç«‹åœº (gpt-5.2)

### æ–¹ A æ ¸å¿ƒä¸»å¼ ï¼ˆä¸€å¥è¯ï¼‰
ä»¥ **Pi ä¸ºä¸»å¹³å°**æ—¶ï¼Œå²å®˜åº”é‡‡ç”¨â€œ**äº‹ä»¶é©±åŠ¨ + æ¡ä»¶è§¦å‘ + å¼‚æ­¥ä¼˜å…ˆï¼ˆå¯é™çº§åŒæ­¥ï¼‰+ é›¶çŠ¶æ€å®¡æŸ¥**â€çš„æ··åˆç”Ÿå‘½å‘¨æœŸï¼š**ä¸ç»‘æ­» agent_end é˜»å¡**ï¼Œè€Œæ˜¯æŠŠå²å®˜æ‹†æˆä¸¤ç±»ä»»åŠ¡â€”â€”â€œå¿«é€Ÿè¿›è¨€â€å’Œâ€œæ·±åº¦å®¡è®¡â€ï¼Œåˆ†åˆ«æŒ‚åœ¨ä¸åŒé’©å­ä¸ä¸åŒè§¦å‘æ¡ä»¶ä¸Šï¼›åœ¨ CC/OC ä¸Šåˆ™ç”¨å…¶åŸç”Ÿ daemon/transform æœºåˆ¶å®ç°ç­‰ä»·æ•ˆæœã€‚

---

## 1) è§¦å‘æ—¶æœºï¼šagent_end vs SessionStart è‡ªå¾ªç¯ï¼ŒåŠç¬¬ä¸‰ç§é€‰æ‹©

### ç»“è®º
- **Pi é‡Œä¸åº”æŠŠå²å®˜å®Œå…¨ç»‘å®šåˆ° agent_end**ï¼šagent_end é˜»å¡ä¼šä¼¤å®³äº¤äº’ä½“éªŒï¼Œä¸”å¯¹â€œä¸ç›¸åªæ˜¯ delegate ä¸€ä¸‹â€çš„å›åˆè¿‡åº¦å®¡è®¡ã€‚
- **CC V11 çš„ SessionStart + SubagentStop è‡ªå¾ªç¯é€‚åˆä½œä¸ºâ€œåå°å®ˆæœ›è€…â€**ï¼Œä½†å®ƒä¾èµ– hook çš„ exit 2 è‡ªå¾ªç¯è¯­ä¹‰ï¼›Pi æ²¡æœ‰ç­‰ä»·æœºåˆ¶ï¼Œç¡¬æŠ„ä¼šå¤±è´¥ã€‚
- **ç¬¬ä¸‰ç§é€‰æ‹©ï¼ˆæ¨èï¼‰**ï¼šåœ¨ Pi é‡‡ç”¨â€œ**åŒé€šé“è§¦å‘**â€
  1) **è½»é‡å²å®˜ï¼ˆFast Historianï¼‰**ï¼šåœ¨ *æ¯æ¬¡ LLM è°ƒç”¨å‰* çš„ `context` äº‹ä»¶é‡Œåšâ€œéœ€ä¸éœ€è¦å®¡æŸ¥â€çš„åˆ¤å®šï¼Œå¹¶ç”¨ `sendMessage({deliverAs:"nextTurn"})` å®‰æ’ä¸‹ä¸€è½®æ³¨å…¥ï¼ˆä¸é˜»å¡å½“å‰è¾“å‡ºï¼‰ã€‚  
  2) **é‡å®¡å²å®˜ï¼ˆDeep Historianï¼‰**ï¼šä»…åœ¨æ»¡è¶³æ¡ä»¶æ—¶ï¼Œäº `agent_end` è§¦å‘ï¼ˆå…è®¸é˜»å¡ï¼Œä½†é¢‘ç‡å¾ˆä½ï¼‰ï¼Œç”¨äºâ€œç»ˆå±€å®¡è®¡/ä¸€è‡´æ€§æ ¡éªŒ/é£é™©å…œåº•â€ã€‚

è¿™ç›¸å½“äºæŠŠ CC çš„â€œdaemon å¸¸é©»â€æ‹†æˆ Pi å¯å®ç°çš„â€œäº‹ä»¶è°ƒåº¦å™¨ + ä½é¢‘é˜»å¡å®¡è®¡â€ã€‚

---

## 2) é˜»å¡ vs å¼‚æ­¥ï¼šä½“éªŒä¸ä¸€è‡´æ€§

### ä¸»å¼ ï¼šé»˜è®¤å¼‚æ­¥ï¼Œå…³é”®åœºæ™¯åŒæ­¥
**é»˜è®¤**ï¼šå²å®˜ä¸é˜»å¡ä¸ç›¸è¾“å‡ºï¼ˆå¼‚æ­¥è¿›è¨€ï¼‰ã€‚  
**ä¾‹å¤–**ï¼šå½“æ£€æµ‹åˆ°é«˜é£é™©æˆ–éœ€è¦æœ€ç»ˆæ”¶æ•›æ—¶ï¼Œæ‰å…è®¸é˜»å¡ï¼ˆåŒæ­¥å®¡è®¡ï¼‰ã€‚

### Pi å…·ä½“å®ç°
- **å¼‚æ­¥è¿›è¨€è·¯å¾„ï¼ˆæ¨èé»˜è®¤ï¼‰**
  - åœ¨ `context` äº‹ä»¶é‡Œè®¡ç®— `reviewNeeded`ï¼ˆè§ç¬¬4èŠ‚æ¡ä»¶è§¦å‘ï¼‰ï¼Œè‹¥éœ€è¦ï¼š
    - `spawn("pi", ["--no-session","--mode","json", ...])` å¯åŠ¨é›¶çŠ¶æ€å²å®˜å­è¿›ç¨‹
    - å²å®˜è¾“å‡ºä¸¤ç±»äº§ç‰©ï¼š
      1) `appendEntry()` å†™å…¥æŒä¹…åŒ–å®¡è®¡è®°å½•ï¼ˆä¸è¿› LLM contextï¼‰
      2) ç”Ÿæˆ `advice` æ–‡æœ¬ï¼Œä¸»è¿›ç¨‹ç”¨ `sendMessage({deliverAs:"nextTurn", ...})` æ³¨å…¥ä¸‹ä¸€è½®ï¼ˆæˆ–åœ¨ `before_agent_start` åˆå¹¶è¿› systemPromptï¼‰
  - è¿™æ ·ç”¨æˆ·å…ˆçœ‹åˆ°ä¸ç›¸å½“è½®è¾“å‡ºï¼Œä¸‹ä¸€è½®ä¸ç›¸ä¼šå¸¦ç€å²å®˜å»ºè®®ç»§ç»­æ²»ç†ã€‚

- **åŒæ­¥å…œåº•è·¯å¾„ï¼ˆä½é¢‘ï¼‰**
  - åœ¨ `agent_end` è§¦å‘ä¸€æ¬¡â€œæœ€ç»ˆå®¡è®¡â€å­è¿›ç¨‹ï¼›å®Œæˆåå†è®©æœ¬è½®ç»“æŸï¼Œä»è€Œä¿è¯â€œç»“æŸæ—¶å·²å®¡è¿‡â€ã€‚

### å¼‚æ­¥ä¸€è‡´æ€§é—®é¢˜ä¸è§£å†³
å¼‚æ­¥ä¼šäº§ç”Ÿâ€œå»ºè®®åˆ°è¾¾æ—¶æœºæ»åâ€çš„é—®é¢˜ã€‚è§£å†³æ–¹å¼æ˜¯æŠŠå»ºè®®è®¾è®¡æˆ**å¯å¹‚ç­‰ã€å¯è¿½æº¯ã€å¯å¿½ç•¥**ï¼š
- æ¯æ¡ advice å¸¦ `turnId / planHash / targetTaskId`ï¼Œä¸ç›¸åœ¨ `before_agent_start` é‡Œåªé‡‡çº³â€œåŒ¹é…å½“å‰è®¡åˆ’â€çš„å»ºè®®ï¼›ä¸åŒ¹é…çš„å†™å…¥ `appendEntry` å½’æ¡£ã€‚
- ä¸ç›¸ systemPrompt åŠ ç¡¬çº¦æŸï¼š**é‡åˆ°å²å®˜ advice å¿…é¡»æ˜¾å¼ Ackï¼ˆæ¥å—/æ‹’ç»/å»¶æœŸï¼‰**ï¼Œå¹¶è¯´æ˜ç†ç”±ï¼Œå½¢æˆå¯å®¡è®¡é—­ç¯ã€‚

---

## 3) é›¶çŠ¶æ€ vs æŒç»­çŠ¶æ€ï¼šå¦‚ä½•æƒè¡¡

### ä¸»å¼ ï¼šPi ä¸ŠåšæŒâ€œé›¶çŠ¶æ€å²å®˜â€ï¼Œç”¨ç»“æ„åŒ–æ‘˜è¦é™ä½é‡å»ºæˆæœ¬
ç†ç”±ï¼š
- ä½ çš„è®¾è®¡åŸåˆ™å·²æ˜ç¡®â€œå²å®˜ç‹¬ç«‹ç›‘ç£ã€é›¶çŠ¶æ€é¿å…åè§â€ï¼Œè¿™æ˜¯åˆ¶åº¦è®¾è®¡ç›®æ ‡ã€‚
- Pi çš„éš”ç¦»å­è¿›ç¨‹ `--no-session --mode json` å¾ˆé€‚åˆåšâ€œå†·å¯åŠ¨å®¡æŸ¥å™¨â€ã€‚

æˆæœ¬é—®é¢˜ç”¨ä¸¤æ‹›è§£å†³ï¼š
1) **æœ€å°ä¸Šä¸‹æ–‡è¾“å…¥**ï¼šå²å®˜ä¸è¯»å–å…¨é‡ messagesï¼Œåªç»™å®ƒä¸€ä»½â€œå®¡è®¡åŒ… (audit packet)â€  
   - ç”±ä¸»è¿›ç¨‹åœ¨ `context` äº‹ä»¶é‡Œç”Ÿæˆï¼šåŒ…å«å½“å‰å›åˆå…³é”®å†³ç­–ã€delegate ç›®æ ‡ã€å·¥å…·è°ƒç”¨æ‘˜è¦ã€é£é™©æ ‡ç­¾ã€ä»¥åŠâ€œå·²å®Œæˆä»»åŠ¡æ‘˜è¦â€ï¼ˆä½ å·²æœ‰ context æ›¿æ¢æœºåˆ¶ï¼‰ã€‚
2) **å¢é‡æŒä¹…åŒ–**ï¼šå²å®˜æ¯æ¬¡ `appendEntry` å­˜ç»“æ„åŒ–è®°å½•ï¼ˆJSONï¼‰ï¼Œä¸‹æ¬¡å®¡è®¡æ—¶ä¸»è¿›ç¨‹åªæŠ½å–æœ€è¿‘ N æ¡ç›¸å…³è®°å½•æ‹¼æˆ audit packetï¼Œä¸è®©å²å®˜ç›´æ¥â€œç»§æ‰¿è®°å¿†â€ã€‚

### CC/OC çš„é€‚é…
- CC V11 çš„ daemon å²å®˜å¤©ç„¶æ˜¯â€œæŒç»­çŠ¶æ€â€ã€‚æ–¹ A å…è®¸ CC ç»§ç»­ç”¨ daemonï¼Œä½†è¦**é€»è¾‘ä¸Šé›¶çŠ¶æ€åŒ–**ï¼š
  - daemon å†…æ¯è½®ä» `pending-advice.md` æˆ– hook æ³¨å…¥ä¸­åªå–â€œæœ€æ–° audit packetâ€ï¼Œå¹¶å¼ºåˆ¶â€œåªä¾æ®è¯¥åŒ…åˆ¤æ–­â€ï¼Œä¸è¦è¯»å†å²å¯¹è¯ï¼ˆæˆ–åœ¨æç¤ºè¯ä¸­å¼ºç¡¬ç¦æ­¢ï¼‰ã€‚
  - åŒæ—¶å®šæœŸè‡ªæˆ‘æ¸…ç†å†…éƒ¨çŠ¶æ€ï¼ˆä¾‹å¦‚æ¯è½®æŠŠè‡ªè¿° summary ç½®ç©ºï¼‰ï¼ŒæŠŠåè§é£é™©é™åˆ°å¯æ¥å—ã€‚

---

## 4) å®Œæ•´æ€§ vs å†—ä½™ï¼šæ¡ä»¶è§¦å‘æœºåˆ¶ï¼ˆå¿…é¡»æœ‰ï¼‰

### ä¸»å¼ ï¼šå²å®˜å®¡æŸ¥å¿…é¡»â€œåˆ†çº§è§¦å‘â€ï¼Œä¸æ˜¯æ¯æ¬¡ agent_end éƒ½è·‘
åœ¨ Pi çš„ `context` äº‹ä»¶é‡Œåš**è§¦å‘åˆ¤å®š**ï¼Œè¾“å‡ºä¸€ä¸ª `reviewLevel: none | fast | deep`ã€‚

å»ºè®®åˆ¤å®šä¿¡å·ï¼ˆéƒ½å¯ä»ä¸ç›¸çš„ç»“æ„åŒ–å·¥ä½œæµé‡Œå¾—åˆ°ï¼‰ï¼š
- `deep`ï¼ˆå°‘ä½†å¿…é¡»ï¼‰ï¼š
  - ä¸ç›¸å‡†å¤‡ç»“æŸæ•´ä¸ªä¼šè¯/é˜¶æ®µï¼ˆæ£€æµ‹åˆ°ç”¨æˆ·â€œç»“æŸ/æ€»ç»“/äº¤ä»˜â€æ„å›¾ï¼‰
  - æœ¬è½®äº§ç”Ÿäº†â€œæœ€ç»ˆäº¤ä»˜ç‰©â€ï¼ˆå†™æ–‡ä»¶ã€å‘å¸ƒã€æ‰§è¡Œç ´åæ€§å‘½ä»¤ç­‰â€”â€”å–å†³äºä½ å·¥å…·é›†ï¼‰
  - ä¹å¿/å·¥äººå‡ºç°å†²çªç»“è®ºã€æˆ–è®¡åˆ’å‘ç”Ÿé‡å¤§å˜æ›´ï¼ˆplanHash å˜åŒ–å¤§ï¼‰
  - å‹ç¼©å³å°†å‘ç”Ÿï¼ˆ`session_before_compact` å‰åï¼‰ï¼Œéœ€è¦å®¡è®¡â€œæ‘˜è¦æ˜¯å¦å¿ å®â€
- `fast`ï¼ˆè¾ƒå¸¸è§ï¼‰ï¼š
  - æœ‰ delegate ç»™ä¹å¿/å·¥äººä¸”ä»»åŠ¡é trivial
  - æœ¬è½®å‡ºç°é£é™©æ ‡ç­¾ï¼ˆå®‰å…¨ã€åˆè§„ã€éšç§ã€æˆæœ¬ã€æ—¶é—´ï¼‰
  - ç”¨æˆ·è¡¨è¾¾ä¸æ»¡/å›°æƒ‘ï¼Œéœ€è¦â€œè¯Šæ–­è¯¯è§£â€
- `none`ï¼š
  - çº¯è·¯ç”±/çº¯ç¡®è®¤ï¼ˆä¾‹å¦‚â€œå¥½çš„æˆ‘å»è®©å·¥äººåš Xâ€ä¸” X æ˜æ˜¾ä½é£é™©ï¼‰
  - æœ¬è½®æ— æ–°å†³ç­–ã€æ— å·¥å…·è°ƒç”¨ã€æ— äº¤ä»˜

å®ç°ä¸Šï¼Œä¸ç›¸æ¯è½®åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª `turnMeta`ï¼ˆå­˜åœ¨ `appendEntry` æˆ– extension stateï¼‰ï¼ŒåŒ…æ‹¬ï¼šdelegate æ¬¡æ•°ã€å·¥å…·è°ƒç”¨æ‘˜è¦ã€æ˜¯å¦äº¤ä»˜ç­‰ï¼›`context` äº‹ä»¶è¯»å–å®ƒå¹¶å†³å®šè§¦å‘ã€‚

---

## 5) ç»ˆç»“å²å®˜ï¼šsession close / ç”¨æˆ·è¯·æ±‚ç»“æŸ

### Pi çš„å¯å®ç°æ–¹æ¡ˆ
Pi æ²¡æœ‰ CC é‚£ç§ Stop hook exit 2 å¼ºè¡Œä¸è®©åœçš„æœºåˆ¶ï¼Œä½†å¯ä»¥åšåˆ°â€œ**ç»“æŸå‰æœ€åä¸€æ¬¡ deep å®¡è®¡**â€ï¼š
- åœ¨ä¸ç›¸æ£€æµ‹åˆ°â€œç”¨æˆ·è¯·æ±‚ç»“æŸ/äº¤ä»˜æœ€ç»ˆæ€»ç»“â€çš„é‚£ä¸€è½®ï¼š
  1) `before_agent_start`ï¼šæŠŠ systemPrompt åˆ‡åˆ°â€œç»ˆå±€æ¨¡å¼â€ï¼Œå¼ºåˆ¶ä¸ç›¸å…ˆåš deep review gateï¼š
     - è‹¥ `reviewLevel=deep` ä¸”å°šæœªå®Œæˆï¼Œåˆ™ä¸ç›¸å¿…é¡»å…ˆè§¦å‘å²å®˜å®¡è®¡ï¼ˆå¯ä»¥èµ° `agent_end` é˜»å¡æˆ–åŒè½®å…ˆ spawn ç­‰å¾…â€”â€”è¿™é‡Œå…è®¸ç‰ºç‰²äº¤äº’æ¢å®Œæ•´æ€§ï¼‰ã€‚
  2) `agent_end`ï¼šå…œåº•å†è·‘ä¸€æ¬¡ deep historianï¼ˆè‹¥æœ¬è½®äº§ç”Ÿæœ€ç»ˆè¾“å‡ºï¼‰ï¼ŒæŠŠæœ€ç»ˆå®¡è®¡è®°å½• `appendEntry`ï¼Œå¹¶æŠŠâ€œæœ€ç»ˆå»ºè®®â€ç”¨ `sendMessage(nextTurn)` æ³¨å…¥ï¼ˆè‹¥ç”¨æˆ·ç»§ç»­è¿½é—®ä»å¯è§ï¼‰ã€‚

æ¢è¨€ä¹‹ï¼šPi ä¸èƒ½â€œé˜»æ­¢åœæ­¢â€ï¼Œä½†å¯ä»¥é€šè¿‡â€œç»ˆå±€æ¨¡å¼æç¤ºè¯ + ä½é¢‘é˜»å¡å®¡è®¡â€è®©ä¸ç›¸è‡ªè§‰ä¸æå‰æ”¶å·¥ï¼Œå¹¶åœ¨æœ€åä¸€è½®æä¾›å®¡è®¡é—­ç¯ã€‚

### CC/OC
- CCï¼šæ²¿ç”¨ Stop hook exit 2 åšå…œåº•ï¼ˆä½ å·²æœ‰ V11 æ¨¡å¼ï¼‰ã€‚
- OCï¼šå¦‚æœèµ° CC bridgeï¼Œå°±ç»§æ‰¿ä¸Šè¿°ï¼›å¦åˆ™ç”¨ `messages.transform` åœ¨æ£€æµ‹åˆ°ç»ˆå±€æ„å›¾æ—¶æ³¨å…¥â€œå¿…é¡»å…ˆè·‘ historian taskâ€çš„æŒ‡ä»¤ï¼Œå¹¶ç”¨åå° `task(run_in_background=true)` è·‘æ·±å®¡ï¼ˆè‹¥å¯ç”¨ï¼‰ã€‚

---

## 6) Hook æ”¾ç½®ï¼šPi ä¸Šå²å®˜é€»è¾‘æŒ‚å“ªé‡Œæœ€åˆç†

### æ¨èåˆ†å·¥ï¼ˆPiï¼‰
1) `context`ï¼ˆæ ¸å¿ƒè°ƒåº¦ç‚¹ï¼‰
   - ç”Ÿæˆ/æ›´æ–° `turnMeta`
   - è®¡ç®— `reviewLevel`
   - æ„é€  audit packetï¼ˆæœ€å°è¾“å…¥ï¼‰
   - è‹¥ `fast/deep` ä¸”é€‰æ‹©å¼‚æ­¥ï¼šç«‹åˆ» spawn historianï¼ˆä¸é˜»å¡ï¼‰ï¼Œå›å†™ advice åˆ°ä¸‹ä¸€è½®
2) `before_agent_start`
   - æŠŠâ€œæœ€æ–°å²å®˜ adviceï¼ˆå¦‚æœ‰ï¼‰â€æ³¨å…¥ systemPromptï¼ˆç¡¬çº¦æŸï¼šå¿…é¡» Ackï¼‰
   - è‹¥å¤„äºâ€œç»ˆå±€æ¨¡å¼â€ä¸”éœ€è¦ deep å®¡è®¡ä½†å°šæœªå®Œæˆï¼šåœ¨ systemPrompt é‡Œå¼ºåˆ¶ä¸ç›¸å…ˆè§¦å‘å®¡è®¡ gateï¼ˆå³å…ˆ delegate ç»™å²å®˜/æˆ–ç­‰å¾…ï¼‰
3) `agent_end`ï¼ˆä½é¢‘å…œåº•ï¼‰
   - ä»…å½“ `reviewLevel=deep` æˆ–ç»ˆå±€æ¨¡å¼ï¼šåŒæ­¥ spawn historianï¼Œå†™å…¥æœ€ç»ˆå®¡è®¡è®°å½•
4) `session_before_compact`
   - å‹ç¼©å‰è·‘ä¸€æ¬¡ `fast` å®¡è®¡ï¼ˆå¯é€‰ï¼‰ï¼Œæˆ–è‡³å°‘è®©å²å®˜éªŒè¯â€œå‹ç¼©æ‘˜è¦å¿ å®æ€§â€ï¼Œå¹¶å°†â€œå‹ç¼©æ ¡éªŒæ‘˜è¦â€ `appendEntry`

---

## Token æˆæœ¬ä¸æ€§èƒ½å½±å“ï¼ˆé‡åŒ–æ€è·¯ï¼‰

- **æœ€å¤§æˆæœ¬æ¥æº**ï¼šå²å®˜ LLM è°ƒç”¨æ¬¡æ•° Ã— æ¯æ¬¡è¾“å…¥ tokenã€‚
- æ–¹ A é€šè¿‡ä¸¤ç‚¹é™æœ¬ï¼š
  1) **æ¡ä»¶è§¦å‘**æŠŠè°ƒç”¨æ¬¡æ•°ä»â€œæ¯è½®â€é™åˆ°â€œæœ‰é£é™©/æœ‰äº¤ä»˜/å°†ç»“æŸ/å°†å‹ç¼©â€æ—¶æ‰è§¦å‘ã€‚ç»éªŒä¸Šå¯ä» 100% é™åˆ° 20â€“40%ï¼ˆè§†ä»»åŠ¡è€Œå®šï¼‰ã€‚
  2) **audit packet æœ€å°åŒ–**æŠŠè¾“å…¥ä»â€œå…¨å¯¹è¯â€é™ä¸ºâ€œç»“æ„åŒ–æ‘˜è¦ + æœ€è¿‘ç›¸å…³ç‰‡æ®µâ€ï¼ŒæŠŠæ¯æ¬¡å²å®˜è¾“å…¥æ§åˆ¶åœ¨ 500â€“1500 tokens é‡çº§ï¼ˆè€Œä¸æ˜¯å‡ åƒä¸Šä¸‡ï¼‰ã€‚
- **é˜»å¡å¼€é”€**ï¼šåªåœ¨ deep å®¡è®¡å‡ºç°ï¼Œä¸”å¯æ§ä¸ºâ€œç»“æŸ/äº¤ä»˜/å‹ç¼©â€è¿™äº›ä½é¢‘èŠ‚ç‚¹ï¼›ç”¨æˆ·ä½“æ„Ÿæ›´åƒâ€œæœ€ç»ˆäº¤ä»˜å‰çš„å®¡ç¨¿æµç¨‹â€ï¼Œåˆç†ã€‚

---

## ä¼˜åŠ¿ä¸æ½œåœ¨é£é™©

### ä¼˜åŠ¿
- **ç¬¦åˆåˆ¶åº¦åŸåˆ™**ï¼šä¸ç›¸è¶…ç„¶ï¼ˆä¸æ‰§è¡Œï¼‰ã€å²å®˜é›¶çŠ¶æ€ã€ä¹å¿å¯å§”æ‰˜ã€å·¥äººåŸå­æ‰§è¡Œï¼›ä¸”ç”¨ç¡¬æœºåˆ¶ï¼ˆå·¥å…·é™åˆ¶ã€é’©å­æ³¨å…¥ï¼‰è€Œä¸æ˜¯å£å¤´çº¦æŸã€‚
- **ä½“éªŒæ›´å¥½**ï¼šå¤§å¤šæ•°å›åˆä¸é˜»å¡ï¼›åªæœ‰ç»ˆå±€ä¸é«˜é£é™©æ‰åŒæ­¥æŠŠå…³ã€‚
- **è·¨å¹³å°å¯è¿ç§»**ï¼šPi ç”¨äº‹ä»¶è°ƒåº¦æ¨¡æ‹Ÿ CC daemonï¼›CC/OC ç”¨åŸç”Ÿ hook/transformå®ç°æ›´å¼ºç‰ˆæœ¬ã€‚

### é£é™©ä¸å¯¹ç­–
- **å¼‚æ­¥å»ºè®®â€œæ¥æ™šäº†â€**ï¼šç”¨ `turnId/planHash` æ ¡éªŒ + ä¸ç›¸å¿…é¡» Ackï¼Œé¿å…é”™ç”¨æ—§å»ºè®®ã€‚
- **æ¡ä»¶è§¦å‘æ¼å®¡**ï¼šæŠŠ deep æ¡ä»¶è®¾è®¡å¾—åä¿å®ˆï¼ˆç»“æŸ/äº¤ä»˜/å‹ç¼©å¿…å®¡ï¼‰ï¼Œå¹¶åœ¨ `session_before_compact` åŠ ä¸€é“â€œæ‘˜è¦å¿ å®æ€§â€æ£€æŸ¥ã€‚
- **å®ç°å¤æ‚åº¦ä¸Šå‡**ï¼šéœ€è¦ç»´æŠ¤ `turnMeta` ä¸ audit packet æ ¼å¼ï¼›ä½†è¿™æ°å¥½æ˜¯å¯æµ‹è¯•ã€å¯åº¦é‡çš„å·¥ç¨‹åŒ–è¾¹ç•Œï¼ˆæ¯”çº¯æç¤ºè¯å¯é ï¼‰ã€‚

---

## è·¨å¹³å°é€‚é…ç­–ç•¥ï¼ˆPi ä¸»ã€CC/OC è¾…ï¼‰

1) **ç»Ÿä¸€æŠ½è±¡ï¼šHistorian Protocol**
- å®šä¹‰æ ‡å‡†è¾“å…¥ `audit packet`ï¼ˆJSONï¼‰ï¼š`turnId, userIntent, planHash, actions, delegations, toolSummary, risks, compactSummary, recentDecisions`
- å®šä¹‰æ ‡å‡†è¾“å‡ºï¼š`advice (short)`, `findings (structured)`, `riskLevel`, `requiredAck`

2) **Pi å®ç°**
- `context` è´Ÿè´£è°ƒåº¦ä¸ packet ç”Ÿæˆï¼›spawn å­è¿›ç¨‹è¿è¡Œ historianï¼›ç”¨ `sendMessage(nextTurn)` + `before_agent_start` æ³¨å…¥ï¼›`appendEntry` å½’æ¡£ï¼›`agent_end` å…œåº• deepã€‚

3) **CC å®ç°**
- SessionStart å¯ daemon historianï¼ˆæ²¿ç”¨ V11ï¼‰ï¼Œä½†æ¯è½®é€šè¿‡ PreToolUse/ PostToolUse æ³¨å…¥çš„ä¹Ÿå¿…é¡»æ˜¯åŒä¸€ä»½ audit packetï¼ˆä¿æŒåè®®ä¸€è‡´ï¼‰ã€‚
- pending-advice.md ä½œä¸ºè·¨å›åˆç¼“å†²ï¼ˆPi ç”¨ appendEntry/extension stateï¼ŒCC ç”¨æ–‡ä»¶ä¸­è½¬ï¼‰ã€‚

4) **OC å®ç°**
- æœ‰ CC bridgeï¼šç›´æ¥å¤ç”¨ CC hooksã€‚
- æ—  bridgeï¼šç”¨ `messages.transform` åœ¨æ¯æ¬¡ API è°ƒç”¨å‰æ³¨å…¥â€œæœ€æ–° advice + Ack çº¦æŸâ€ï¼Œåå°ç”¨ `task(run_in_background=true)` è·‘ historianï¼ˆè‹¥æ”¯æŒï¼‰ï¼Œå¦åˆ™é€€åŒ–ä¸ºåŒæ­¥ã€‚

---

**æ€»ç»“**ï¼šæ–¹ A è®¤ä¸ºâ€œå²å®˜ç”Ÿå‘½å‘¨æœŸâ€ä¸åº”äºŒé€‰ä¸€ï¼ˆagent_end é˜»å¡ or SessionStart daemonï¼‰ï¼Œè€Œåº”åœ¨ Pi é‡‡ç”¨â€œäº‹ä»¶è°ƒåº¦ + æ¡ä»¶è§¦å‘ + å¼‚æ­¥ä¼˜å…ˆ + ä½é¢‘åŒæ­¥å…œåº•â€çš„æ··åˆæ¨¡å‹ï¼›åœ¨ CC/OC ä»¥åè®®åŒ–çš„ audit packet å¤ç”¨å…¶ daemon/transform ä¼˜åŠ¿ï¼Œå®ç°ä¸€è‡´çš„æ²»ç†æ•ˆæœä¸å¯æ§çš„ token æˆæœ¬ã€‚

---

### Party B â€” åˆå§‹ç«‹åœº (kimi-k2.5)

# æ–¹ Bï¼šã€Œå¼‚æ­¥æ¡ä»¶è§¦å‘ + åˆ†å±‚å²å®˜ã€æ–¹æ¡ˆ

## æ ¸å¿ƒä¸»å¼ 

**å²å®˜ä¸åº”æ˜¯å•ä¸€è§’è‰²ï¼Œè€Œåº”æ˜¯åˆ†å±‚æ¶æ„ï¼›ä¸åº”é˜»å¡ä¸»æµç¨‹ï¼Œè€Œåº”å¼‚æ­¥æ¡ä»¶è§¦å‘ï¼›ä¸åº”å®Œå…¨é›¶çŠ¶æ€ï¼Œè€Œåº”ä¿æŒ"åˆ¶åº¦æ€§è®°å¿†"è€Œé"äº‹åŠ¡æ€§åè§"ã€‚**

æˆ‘åå¯¹ Pi æ–¹æ¡ˆçš„ agent_end é˜»å¡å¼å•æ¬¡å®¡æŸ¥ï¼Œä¹Ÿåå¯¹ CC V11 çš„ daemon è‡ªå¾ªç¯æ¨¡å¼ã€‚å‰è€…ç‰ºç‰²ç”¨æˆ·ä½“éªŒæ¢å–ç®€å•æ€§ï¼Œåè€…ç”¨å¤æ‚ hook åä½œå®ç°è§£è€¦å´å¼•å…¥çŠ¶æ€æ±¡æŸ“é£é™©ã€‚æˆ‘çš„æ–¹æ¡ˆæ˜¯ï¼š**æ¡ä»¶è§¦å‘çš„å¼‚æ­¥è½»é‡å²å®˜ï¼ˆLight Historianï¼‰+ å‘¨æœŸèšåˆçš„æ·±åº¦å²å®˜ï¼ˆDeep Historianï¼‰åŒå±‚æ¨¡å‹**ã€‚

---

## ä¸€ã€è§¦å‘æœºåˆ¶ï¼šæ¡ä»¶é©±åŠ¨çš„å¼‚æ­¥è§¦å‘

### 1.1 è§¦å‘æ¡ä»¶è®¾è®¡ï¼ˆç¡¬ç¼–ç ï¼‰

```typescript
// historian-trigger.ts - æŒ‚è½½äº Pi çš„ context äº‹ä»¶
interface TriggerCondition {
  type: 'MANDATORY' | 'CONDITIONAL' | 'PERIODIC';
  check: (context: Message[]) => boolean;
}

const TRIGGER_RULES: TriggerCondition[] = [
  // å¼ºåˆ¶è§¦å‘ï¼šä»»ä½• delegate å·¥å…·è°ƒç”¨å
  {
    type: 'MANDATORY',
    check: (ctx) => hasToolCall(ctx, 'delegate')
  },
  // æ¡ä»¶è§¦å‘ï¼šå•è½® token > 4000 æˆ–ç´¯è®¡ 3 è½®æ— å®¡æŸ¥
  {
    type: 'CONDITIONAL', 
    check: (ctx) => estimateToken(ctx) > 4000 || getRoundsSinceLastReview() >= 3
  },
  // å‘¨æœŸè§¦å‘ï¼šæ¯ 5 åˆ†é’Ÿ wall-clockï¼ˆé€šè¿‡ appendEntry æ—¶é—´æˆ³ï¼‰
  {
    type: 'PERIODIC',
    check: () => Date.now() - lastReviewTime > 300000
  }
];
```

### 1.2 Pi å¹³å°å®ç°ï¼šéé˜»å¡å¼‚æ­¥è§¦å‘

Pi çš„ `agent_end` æ˜¯é˜»å¡çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ **`sendMessage({deliverAs: "nextTurn"})` + ç‰¹æ®Šæ ‡è®°æ¶ˆæ¯** å®ç°ä¼ªå¼‚æ­¥ï¼š

```typescript
// åœ¨ context äº‹ä»¶ä¸­æ£€æµ‹è§¦å‘æ¡ä»¶ï¼Œä¸é˜»å¡å½“å‰è½®æ¬¡
pi.on('context', async (event) => {
  const shouldTrigger = checkTriggerConditions(event.messages);
  
  if (shouldTrigger && !event.messages.some(m => m.metadata?.historianPending)) {
    // æ³¨å…¥æ ‡è®°ï¼Œä¸‹ä¸€è½®ç”±ä¸ç›¸"è‡ªå‘"å§”æ‰˜å²å®˜
    event.messages.push({
      role: 'user',
      content: '[SYSTEM] æ£€æµ‹åˆ°éœ€è¦å²å®˜å®¡æŸ¥çš„æ¡ä»¶ï¼Œè¯·åœ¨ä¸‹ä¸€æ­¥è°ƒç”¨ review_with_historianã€‚',
      metadata: { historianPending: true, triggerReason: shouldTrigger }
    });
  }
  
  return structuredClone(event.messages);
});

// ä¸ç›¸çš„ read å·¥å…·çœ‹åˆ°æ ‡è®°åï¼Œä½¿ç”¨ delegate å¯åŠ¨å²å®˜
// è¿™æ˜¯"è½¯è§¦å‘"ï¼Œä½†é…åˆ systemPrompt ç¡¬çº¦æŸæˆä¸ºäº‹å®å¼ºåˆ¶
```

**å…³é”®æŠ€å·§**ï¼šåˆ©ç”¨ `before_agent_start` åŠ¨æ€ä¿®æ”¹ systemPromptï¼Œå½“æ£€æµ‹åˆ° `historianPending` æ ‡è®°æ—¶ï¼Œå¼ºåˆ¶æ’å…¥æŒ‡ä»¤ï¼š"ä½ å¿…é¡»å…ˆè°ƒç”¨ delegate å·¥å…·å°†ä¸Šä¸‹æ–‡æäº¤å²å®˜å®¡æŸ¥ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œç”¨æˆ·è¯·æ±‚ã€‚"

### 1.3 å¯¹æ¯” CC V11 çš„æ”¹è¿›

| ç»´åº¦ | CC V11 | æˆ‘æ–¹æ–¹æ¡ˆ |
|------|--------|---------|
| è§¦å‘æ—¶æœº | SubagentStop exit 2 æ‹¦æˆª | context äº‹ä»¶æ¡ä»¶æ£€æµ‹ |
| ä¸»æµç¨‹æ„ŸçŸ¥ | å®Œå…¨æ— æ„ŸçŸ¥ï¼ˆdaemonï¼‰ | æ˜ç¡®æ„ŸçŸ¥ï¼ˆæ ‡è®°æ¶ˆæ¯ï¼‰ |
| æ§åˆ¶æµ | 6 hooks éšå¼åä½œ | 2 hooks + æ˜¾å¼ delegate |
| è°ƒè¯•æ€§ | å›°éš¾ï¼ˆhook é“¾è¿½è¸ªï¼‰ | æ¸…æ™°ï¼ˆæ¶ˆæ¯é“¾å¯è§ï¼‰ |

---

## äºŒã€è¿è¡Œæ¨¡å¼ï¼šLight vs Deep åˆ†å±‚å²å®˜

### 2.1 Light Historianï¼ˆè½»é‡å²å®˜ï¼‰

**å®šä½**ï¼šå¿«é€Ÿåˆè§„æ£€æŸ¥ï¼ŒToken é¢„ç®— < 1000

**è§¦å‘åœºæ™¯**ï¼šæ¯æ¬¡ delegate åã€é«˜é¢‘æ¡ä»¶è§¦å‘

**å®ç°**ï¼ˆPi spawn å‚æ•°ä¼˜åŒ–ï¼‰ï¼š
```bash
pi --no-session --mode json \
   --tools read-only \           # ä¸¥æ ¼åªè¯»
   --max-tokens 800 \            # ç¡¬é™åˆ¶
   --system-prompt-file light-historian.md
```

**èŒè´£è¾¹ç•Œ**ï¼š
- æ£€æŸ¥ï¼šæƒé™è¶Šç•Œã€å·¥å…·æ»¥ç”¨ã€è¾“å‡ºæ ¼å¼åˆè§„
- äº§å‡ºï¼š`advice.json`ï¼ˆç»“æ„åŒ–ï¼Œ< 200 tokensï¼‰
- ç¦æ­¢ï¼šæˆ˜ç•¥å»ºè®®ã€å†å²å…³è”åˆ†æ

### 2.2 Deep Historianï¼ˆæ·±åº¦å²å®˜ï¼‰

**å®šä½**ï¼šå‘¨æœŸæ€§æ·±åº¦å®¡æŸ¥ï¼ŒToken é¢„ç®— 4000-8000

**è§¦å‘åœºæ™¯**ï¼šæ¯ N è½® Light å®¡æŸ¥åã€session_before_compact å‰ã€ç”¨æˆ·ä¸»åŠ¨è¯·æ±‚

**å®ç°**ï¼ˆåˆ©ç”¨ Pi çš„ session_before_compactï¼‰ï¼š
```typescript
pi.on('session_before_compact', async (session) => {
  // åœ¨å‹ç¼©å‰è·å–å®Œæ•´ä¸Šä¸‹æ–‡çª—å£
  const fullHistory = await session.getMessages();
  
  // å¼‚æ­¥ spawn Deep Historianï¼Œä¸é˜»å¡å‹ç¼©
  const deepReview = spawn('pi', [
    '--no-session', '--mode', 'json',
    '--context-stdin'  // è‡ªå®šä¹‰ï¼šé€šè¿‡ stdin æ³¨å…¥å®Œæ•´å†å²
  ]);
  
  deepReview.stdin.write(JSON.stringify({
    messages: fullHistory,
    lightReviews: await collectLightReviews(), // ä» appendEntry è¯»å–
    compactPlan: session.compactPlan  // äº†è§£å³å°†ä¸¢å¤±çš„ä¿¡æ¯
  }));
  
  // éé˜»å¡ï¼šç»“æœå†™å…¥ pending-deep-adviceï¼Œä¸‹è½®æ³¨å…¥
  deepReview.on('exit', (code) => {
    if (code === 0) {
      pi.sendMessage({
        deliverAs: 'nextTurn',
        content: `[DEEP_REVIEW] ${readFileSync('pending-deep-advice.json')}`
      });
    }
  });
});
```

### 2.3 çŠ¶æ€ç®¡ç†ï¼šåˆ¶åº¦æ€§è®°å¿† vs äº‹åŠ¡æ€§åè§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ¶åº¦æ€§è®°å¿†ï¼ˆæŒä¹…åŒ–ï¼ŒLight/Deep å…±äº«ï¼‰      â”‚
â”‚  - court-rules.md       # æœå»·æ³•åº¦         â”‚
â”‚  - tool-permissions.json # å·¥å…·æƒé™çŸ©é˜µ     â”‚
â”‚  - minister-profiles/   # ä¹å¿èƒ½åŠ›ç”»åƒ      â”‚
â”‚  ï¼ˆé€šè¿‡ --mount æŒ‚è½½ä¸ºåªè¯»æ–‡ä»¶ï¼‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº‹åŠ¡æ€§çŠ¶æ€ï¼ˆé›¶çŠ¶æ€ï¼Œæ¯æ¬¡é‡å»ºï¼‰              â”‚
â”‚  - å½“å‰ task çš„å®Œæ•´æ¶ˆæ¯é“¾                   â”‚
â”‚  - æœ¬è½® delegate çš„è¾“å…¥è¾“å‡º                 â”‚
â”‚  - ä¸Šä¸€æ¬¡çš„ adviceï¼ˆä»…ä½œä¸ºå‚è€ƒï¼Œéä¾æ®ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è®¾è®¡**ï¼šå²å®˜é€šè¿‡ `appendEntry()` å†™å…¥çš„å®¡æŸ¥è®°å½• **ä¸è¿› LLM ä¸Šä¸‹æ–‡**ï¼Œä½†å¯ä»¥é€šè¿‡ `read` å·¥å…·æ˜¾å¼æŸ¥è¯¢ã€‚è¿™å®ç°äº†"å¯æ£€ç´¢çš„å†å²"è€Œé"ä¸å¯æ§çš„åè§"ã€‚

---

## ä¸‰ã€ç»ˆç»“æœºåˆ¶ï¼šä¸‰çº§å…œåº•

### 3.1 æ­£å¸¸ç»ˆç»“ï¼šä»»åŠ¡å®Œæˆä¿¡å·

```typescript
// ä¸ç›¸æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆæ—¶ï¼Œæ˜¾å¼å‘é€ç»ˆæ­¢æ ‡è®°
interface TerminationSignal {
  type: 'TASK_COMPLETE' | 'SESSION_END' | 'USER_ABORT';
  finalSummary: string;  // ä¸ç›¸è‡ªè¯„
}
```

### 3.2 Pi å¹³å°çš„ session ç»ˆç»“å¤„ç†

Pi æ²¡æœ‰ CC çš„ Stop hookï¼Œä½†å¯ä»¥åˆ©ç”¨ `agent_end` çš„å˜ä½“è¡Œä¸ºï¼š

```typescript
// æ–¹æ¡ˆ Aï¼šåˆ©ç”¨è¿›ç¨‹ä¿¡å·ï¼ˆéœ€ Pi æ”¯æŒ signal forwardingï¼‰
process.on('SIGTERM', async () => {
  // åŒæ­¥é˜»å¡ï¼šå¿…é¡»å®Œæˆæœ€ç»ˆå²å®˜å®¡æŸ¥
  const finalHistorian = spawnSync('pi', [
    '--no-session',
    '--final-review-mode',  // è‡ªå®šä¹‰ï¼šå¯ç”¨ç»ˆæå®¡æŸ¥æ¨¡å¼
    '--timeout', '30000'    // 30ç§’ç¡¬é™åˆ¶ï¼Œé˜²æ­¢æ— é™é˜»å¡
  ]);
  
  appendEntry('FINAL_AUDIT_LOG', finalHistorian.stdout);
});

// æ–¹æ¡ˆ Bï¼šåˆ©ç”¨ before_agent_start æ£€æµ‹ç»ˆæ­¢æ„å›¾
pi.on('before_agent_start', (prompt, context) => {
  if (detectTerminationIntent(context)) {
    // æ³¨å…¥ç»ˆæå®¡æŸ¥æŒ‡ä»¤ï¼Œå¼ºåˆ¶ä¸€è½®å²å®˜å§”æ‰˜
    return injectFinalReviewPrompt(prompt);
  }
});
```

### 3.3 è·¨å¹³å°ç»Ÿä¸€ï¼šAdvice æ–‡ä»¶åè®®

æ— è®ºå“ªä¸ªå¹³å°ï¼Œå²å®˜è¾“å‡ºéµå¾ªç»Ÿä¸€ schemaï¼š

```yaml
# advice-v1.schema.yaml
type: object
required: [version, historianType, findings, action]
properties:
  version: { const: "1.0" }
  historianType: { enum: [light, deep, final] }
  findings:
    type: array
    items:
      type: object
      properties:
        severity: { enum: [info, warning, critical] }
        category: { enum: [security, efficiency, compliance, strategy] }
        description: { type: string }
  action:
    type: object
    properties:
      type: { enum: [proceed, pause, escalate, revise] }
      target: { enum: [chancellor, minister, worker, user] }
      payload: { type: string }  # å…·ä½“å»ºè®®å†…å®¹
```

---

## å››ã€è·¨å¹³å°é€‚é…ç­–ç•¥

### 4.1 å¹³å°èƒ½åŠ›çŸ©é˜µ

| æœºåˆ¶ | Pi Extension | CC Hooks | OC |
|------|-----------|----------|-----|
| å¼‚æ­¥è§¦å‘ | sendMessage(nextTurn) | SubagentStop exit 2 | messages.transform |
| æ¡ä»¶æ‹¦æˆª | context äº‹ä»¶è¿‡æ»¤ | PreToolUse updatedInput | messages.transform |
| å­è¿›ç¨‹éš”ç¦» | spawn("pi", ...) | Sub-Agent Task | .opencode/agents/*.md |
| æŒä¹…åŒ–å­˜å‚¨ | appendEntry() | pending-advice.md | Plugin storage API |
| ç»ˆç»“é’©å­ | agent_end / ä¿¡å· | Stop hook exit 2 | Plugin unload |

### 4.2 å„å¹³å°é€‚é…å±‚

**Piï¼ˆåŸç”Ÿç›®æ ‡ï¼‰**ï¼šå®Œæ•´å®ç°ä¸Šè¿°æ–¹æ¡ˆ

**CCï¼ˆé€šè¿‡ OC bridgeï¼‰**ï¼š
```typescript
// oc-cc-bridge.ts
export const ccHistorianAdapter = createClaudeCodeHooksHook({
  // å°† OC çš„ messages.transform æ˜ å°„åˆ° Pi çš„ context è¯­ä¹‰
  onPreProcess: (messages) => {
    const trigger = checkTriggerConditions(messages);
    if (trigger) {
      // æ¨¡æ‹Ÿ Pi çš„ sendMessage(nextTurn)
      return injectSystemMessage(messages, '[HISTORIAN_TRIGGER]');
    }
    return messages;
  },
  
  // å°† CC çš„ SubagentStop æ˜ å°„åˆ° Light Historian spawn
  onSubagentStop: (subagent) => {
    if (subagent.role === 'historian') {
      // é˜»æ­¢åœæ­¢ï¼Œä½†æˆ‘ä»¬çš„æ–¹æ¡ˆä¸éœ€è¦ daemon æ¨¡å¼
      // æ”¹ä¸ºï¼šæ­£å¸¸é€€å‡ºï¼Œç»“æœå†™å…¥ pending-advice
      return { action: 'ALLOW_EXIT', outputTo: 'pending-advice.md' };
    }
  }
});
```

**OCï¼ˆåŸç”Ÿæ‰©å±•ï¼‰**ï¼š
```yaml
# .opencode/agents/historian-light.md
---
name: historian-light
model: claude-sonnet-4-20250514
tools: [read_file, write_file]
run_in_background: true  # OC ç‰¹æœ‰ï¼šçœŸå¼‚æ­¥
on_complete: notify_parent  # è‡ªå®šä¹‰ï¼šé€šçŸ¥ä¸» agent
---

ä½ çš„èŒè´£æ˜¯å¿«é€Ÿåˆè§„æ£€æŸ¥...
```

### 4.3 Token æˆæœ¬åˆ†æ

| åœºæ™¯ | é˜»å¡å¼ Pi åŸæ–¹æ¡ˆ | CC V11 daemon | æˆ‘æ–¹åˆ†å±‚æ–¹æ¡ˆ |
|------|---------------|-------------|-----------|
| ç®€å• delegateï¼ˆ1 è½®ï¼‰ | ~1500 tokensï¼ˆå²å®˜å…¨é‡ï¼‰ | ~800 tokensï¼ˆå¢é‡ï¼‰ | ~400 tokensï¼ˆLight onlyï¼‰|
| å¤æ‚ä»»åŠ¡ï¼ˆ10 è½®ï¼‰ | ~15000 tokens | ~6000 tokensï¼ˆç´¯ç§¯ï¼‰ | ~8000 tokensï¼ˆ7Ã—Light + 1Ã—Deepï¼‰|
| ç©ºè½¬æˆæœ¬ | 0 | ~200 tokens/è½®ï¼ˆdaemon è‡ªæ£€ï¼‰| 0 |
| å³°å€¼å»¶è¿Ÿ | é«˜ï¼ˆé˜»å¡ï¼‰ | ä½ | ä¸­ï¼ˆä¼ªå¼‚æ­¥ï¼‰|

**å…³é”®ä¼˜åŒ–**ï¼šDeep Historian åœ¨ `session_before_compact` è§¦å‘ï¼Œæ­¤æ—¶ä¸Šä¸‹æ–‡å³å°†è¢«å‹ç¼©ï¼Œå¯ä»¥ç”¨"å…è´¹"çš„å®Œæ•´çª—å£åšæ·±åº¦åˆ†æï¼Œä¸é¢å¤–æ¶ˆè€— LLM è°ƒç”¨é…é¢ã€‚

---

## äº”ã€ä¼˜åŠ¿ä¸é£é™©

### 5.1 æ ¸å¿ƒä¼˜åŠ¿

1. **ä½“éªŒä¸å®‰å…¨çš„å¹³è¡¡**ï¼šä¼ªå¼‚æ­¥é¿å…é˜»å¡ï¼Œæ¡ä»¶è§¦å‘å‡å°‘å†—ä½™ï¼Œåˆ†å±‚è®¾è®¡åŒ¹é…ä¸åŒå®‰å…¨ç­‰çº§éœ€æ±‚
2. **å¯è°ƒè¯•æ€§**ï¼šæ‰€æœ‰è§¦å‘æ¡ä»¶ã€å²å®˜å†³ç­–éƒ½æœ‰æ¶ˆæ¯é“¾ç•™ç—•ï¼Œä¸åƒ CC V11 çš„ hook é“¾éš¾ä»¥è¿½è¸ª
3. **æ¸è¿›å¼éƒ¨ç½²**ï¼šå¯å…ˆéƒ¨ç½² Light Historianï¼ŒéªŒè¯åå†å¯ç”¨ Deepï¼Œé™ä½è¿ç§»é£é™©
4. **è·¨å¹³å°ä¸€è‡´æ€§**ï¼šAdvice æ–‡ä»¶åè®®ä½œä¸ºæŠ½è±¡å±‚ï¼Œå¹³å°é€‚é…å™¨éš”ç¦»å·®å¼‚

### 5.2 æ½œåœ¨é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£æªæ–½ |
|-----|---------|
| ä¼ªå¼‚æ­¥çš„"è½¯è§¦å‘"è¢«ç»•è¿‡ | `before_agent_start` åŠ¨æ€ systemPrompt å¼ºåˆ¶åŒ– + å·¥å…·å±‚é¢çš„ `setActiveTools` é™åˆ¶ï¼ˆæ—  review æ ‡è®°åˆ™ç¦ç”¨å…³é”®å·¥å…·ï¼‰|
| Deep Historian é•¿æ—¶é—´è¿è¡Œé˜»å¡å‹ç¼© | 30 ç§’ timeout + é™çº§ä¸º Light Historian æ‘˜è¦ |
| å¤šå¹³å° Advice æ ¼å¼ä¸ä¸€è‡´ | JSON Schema æ ¡éªŒ + CI æµ‹è¯•çŸ©é˜µ |
| æ¡ä»¶è§„åˆ™é—æ¼ edge case | é»˜è®¤ä¿å®ˆç­–ç•¥ï¼šä¸ç¡®å®šæ—¶è§¦å‘ Light Historian |

---

## å…­ã€ç»“è®º

å²å®˜çš„ç”Ÿå‘½å‘¨æœŸä¸åº”æ˜¯"é˜»å¡å•æ¬¡"æˆ–"daemon æ°¸ç»­"çš„äºŒé€‰ä¸€ï¼Œè€Œåº”æ˜¯**æ¡ä»¶é©±åŠ¨çš„åˆ†å±‚å¼‚æ­¥æ¨¡å‹**ã€‚Pi çš„ `context` + `sendMessage(nextTurn)` + `before_agent_start` ä¸‰é’©åä½œï¼Œè¶³ä»¥å®ç°æ¯” CC V11 æ›´é€æ˜ã€æ›´å¯è°ƒè¯•çš„ç­‰æ•ˆæœºåˆ¶ï¼ŒåŒæ—¶ä¿æŒè·¨å¹³å°é€‚é…çš„çµæ´»æ€§ã€‚

---

### Party C â€” åˆå§‹ç«‹åœº (claude-sonnet-4-6)

# æ–¹ Cï¼šå²å®˜çš„ã€Œè„‰å†²å¼ç‹¬ç«‹å®¡åˆ¤ã€æ¨¡å‹

## æ ¸å¿ƒä¸»å¼ 

**å²å®˜ä¸åº”è¯¥æ˜¯ daemonï¼Œä¹Ÿä¸åº”è¯¥æ˜¯æ¯æ¬¡ agent_end éƒ½ç›²ç›®è§¦å‘çš„æ©¡çš®å›¾ç« â€”â€”å²å®˜åº”è¯¥æ˜¯ä¸€ä¸ªã€Œæœ‰æ¡ä»¶è§¦å‘çš„ã€é›¶çŠ¶æ€çš„ã€åŒæ­¥é˜»å¡çš„ç‹¬ç«‹å®¡åˆ¤è€…ã€ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸç”±ã€Œäº‹ä»¶ä¸¥é‡æ€§è¯„ä¼°ã€é©±åŠ¨ï¼Œè€Œéæ—¶é—´æˆ–è½®æ¬¡é©±åŠ¨ã€‚**

æ–¹ Aï¼ˆPi çš„æ¯è½® agent_end é˜»å¡ï¼‰è¿‡äºé¢‘ç¹ï¼ŒæŠŠå²å®˜å˜æˆäº†æµæ°´çº¿ä¸Šçš„è´¨æ£€å‘˜ï¼›æ–¹ Bï¼ˆCC V11 çš„ daemon è‡ªå¾ªç¯ï¼‰çŠ¶æ€æ±¡æŸ“é£é™©é«˜ï¼Œä¸” pending-advice.md æ–‡ä»¶ä¸­è½¬å¼•å…¥äº†ç«æ€æ¡ä»¶ã€‚æˆ‘çš„æ–¹æ¡ˆå–ä¸¤è€…ä¹‹é•¿ï¼š**é›¶çŠ¶æ€ä¿è¯ç‹¬ç«‹æ€§ï¼Œæ¡ä»¶è§¦å‘ä¿è¯æ•ˆç‡ï¼ŒåŒæ­¥é˜»å¡ä¿è¯ä¸€è‡´æ€§**ã€‚

---

## ä¸€ã€è§¦å‘æ—¶æœºï¼šäº‹ä»¶ä¸¥é‡æ€§è¯„åˆ†åˆ¶

### æ ¸å¿ƒæœºåˆ¶

åœ¨ Pi çš„ `agent_end` hook ä¸­ï¼Œä¸æ˜¯æ— æ¡ä»¶ spawn å²å®˜ï¼Œè€Œæ˜¯å…ˆåšä¸€æ¬¡**è½»é‡çº§è¯„åˆ†**ï¼š

```javascript
// agent_end hook (Pi Extension)
hooks.on('agent_end', async (ctx) => {
  const severity = computeSeverity(ctx);
  
  // ä¸¥é‡æ€§é˜ˆå€¼ï¼šä½äº 30 åˆ†è·³è¿‡å²å®˜
  if (severity < 30) {
    await ctx.appendEntry({
      type: 'historian_skip',
      reason: `severity=${severity}, below threshold`,
      timestamp: Date.now()
    });
    return; // ç›´æ¥æ”¾è¡Œ
  }
  
  // é«˜äºé˜ˆå€¼ï¼Œspawn å²å®˜ï¼ˆé˜»å¡ï¼‰
  await spawnHistorian(ctx, severity);
});

function computeSeverity(ctx) {
  let score = 0;
  const tools = ctx.toolsUsed ?? [];
  
  // å†™æ“ä½œæƒé‡é«˜
  if (tools.some(t => ['write_file','edit','bash'].includes(t))) score += 40;
  // å§”æ‰˜è¡Œä¸º
  if (tools.includes('delegate')) score += 20;
  // å¤–éƒ¨è°ƒç”¨
  if (tools.some(t => t.startsWith('mcp_'))) score += 30;
  // çº¯è¯»æ“ä½œ
  if (tools.every(t => t === 'read')) score += 5;
  // ä»»åŠ¡æ·±åº¦ï¼ˆä¹å¿å±‚è§¦å‘æ¯”å·¥äººå±‚æƒé‡é«˜ï¼‰
  score += (ctx.env.PI_COURT_DEPTH ?? 0) * 10;
  
  return score;
}
```

### è§¦å‘çŸ©é˜µ

| åœºæ™¯ | è¯„åˆ† | å²å®˜è§¦å‘ | ç†ç”± |
|------|------|----------|------|
| ä¸ç›¸ä»… read + delegate | 25 | âŒ | çº¯ç›‘ç£åŠ¨ä½œï¼Œæ— éœ€å®¡æŸ¥ |
| ä¹å¿æ‰§è¡Œå†™æ–‡ä»¶ | 60 | âœ… | å†™æ“ä½œæœ‰å‰¯ä½œç”¨ |
| å·¥äººè°ƒç”¨ MCP å¤–éƒ¨æœåŠ¡ | 70 | âœ… | å¤–éƒ¨è°ƒç”¨ä¸å¯é€† |
| å·¥äººåªè¯»å–æ–‡ä»¶ | 5 | âŒ | é›¶å‰¯ä½œç”¨ |
| ä»»ä½•å±‚çº§å‡ºç° error | 100 | âœ… å¼ºåˆ¶ | é”™è¯¯å¿…é¡»å®¡æŸ¥ |

è¿™è§£å†³äº†ã€Œå®Œæ•´æ€§ vs å†—ä½™ã€çš„çŸ›ç›¾ï¼š**å²å®˜æ˜¯æ³•å®˜ï¼Œä¸æ˜¯æ¯æ¬¡éƒ½å¼€åº­ï¼Œä½†é‡æ¡ˆå¿…é¡»å¼€åº­**ã€‚

---

## äºŒã€è¿è¡Œæ¨¡å¼ï¼šé›¶çŠ¶æ€ + ä¸Šä¸‹æ–‡é‡å»ºåŒ…

### ä¸ºä»€ä¹ˆåšæŒé›¶çŠ¶æ€

CC V11 çš„ daemon è‡ªå¾ªç¯æ¨¡å‹æœ‰ä¸€ä¸ªæ ¹æœ¬æ€§é£é™©ï¼šå²å®˜åœ¨åŒä¸€ session å†…ç§¯ç´¯äº†å¯¹ä¸ç›¸å·¥ä½œæ–¹å¼çš„ã€Œå°è±¡ã€ã€‚ç¬¬ 50 æ¬¡å®¡æŸ¥æ—¶ï¼Œå²å®˜å¯èƒ½å·²ç»å½¢æˆäº†ã€Œè¿™ä¸ªé¡¹ç›®å°±æ˜¯è¿™æ ·åšçš„ã€çš„åè§ï¼Œå¼€å§‹æ”¾æ°´ã€‚**é›¶çŠ¶æ€æ˜¯å²å®˜ç‹¬ç«‹æ€§çš„åˆ¶åº¦ä¿éšœï¼Œä¸æ˜¯æŠ€æœ¯é€‰æ‹©ï¼Œæ˜¯æ”¿æ²»é€‰æ‹©**ã€‚

### ä¸Šä¸‹æ–‡é‡å»ºåŒ…ï¼ˆContext Packageï¼‰

é›¶çŠ¶æ€çš„ä»£ä»·æ˜¯æ¯æ¬¡é‡å»ºä¸Šä¸‹æ–‡ï¼Œä½†è¿™ä¸ªé‡å»ºå¯ä»¥åšå¾—å¾ˆç²¾å‡†ï¼š

```javascript
async function spawnHistorian(ctx, severity) {
  // æ„å»ºæœ€å°åŒ–ä¸Šä¸‹æ–‡åŒ…
  const contextPackage = {
    // 1. é¡¹ç›®å®ªæ³•ï¼ˆä¸å˜é‡ï¼Œä»ç£ç›˜è¯»ï¼‰
    constitution: await readFile('.pi/court-constitution.md'),
    
    // 2. æœ¬è½®äº‹ä»¶æ‘˜è¦ï¼ˆä¸æ˜¯å®Œæ•´ transcriptï¼‰
    eventSummary: {
      role: ctx.env.PI_COURT_ROLE,
      depth: ctx.env.PI_COURT_DEPTH,
      toolsUsed: ctx.toolsUsed,
      outcome: ctx.outcome, // success/error/partial
      severity: severity,
      // å…³é”®ï¼šåªä¼ æœ€å N æ¡æ¶ˆæ¯ï¼Œä¸ä¼ å…¨é‡ context
      recentMessages: ctx.messages.slice(-10)
    },
    
    // 3. å†å²å®¡æŸ¥è®°å½•æ‘˜è¦ï¼ˆappendEntry å­˜å‚¨çš„ï¼Œä¸æ˜¯ LLM contextï¼‰
    historicalAdvice: await readLastNAdvice(5), // æœ€è¿‘ 5 æ¡å»ºè®®
    
    // 4. å½“å‰ä»»åŠ¡ç›®æ ‡ï¼ˆä» session metadata è¯»ï¼‰
    missionStatement: ctx.sessionMeta.mission
  };
  
  // spawn å®Œå…¨éš”ç¦»çš„å²å®˜è¿›ç¨‹
  const historian = spawn('pi', [
    '--no-session',
    '--mode', 'json',
    '--tools', 'read', // å²å®˜åªæœ‰ readï¼Œç¡¬çº¦æŸ
    '--system', buildHistorianPrompt(contextPackage),
    '--input', JSON.stringify(contextPackage.eventSummary)
  ]);
  
  const advice = await collectOutput(historian); // é˜»å¡ç­‰å¾…
  
  // å¤„ç†å²å®˜è¾“å‡º
  await processHistorianAdvice(ctx, advice);
}
```

**å…³é”®è®¾è®¡**ï¼šä¼ ç»™å²å®˜çš„ä¸æ˜¯å®Œæ•´çš„ LLM contextï¼ˆé‚£ä¼šå¾ˆè´µï¼‰ï¼Œè€Œæ˜¯ä¸€ä¸ª**ç»“æ„åŒ–çš„äº‹ä»¶æ‘˜è¦åŒ…**ã€‚å²å®˜çš„ token æ¶ˆè€—ä¸»è¦æ¥è‡ª system promptï¼ˆå®ªæ³• + è§’è‰²å®šä¹‰ï¼‰ï¼Œè€Œä¸æ˜¯å®Œæ•´å¯¹è¯å†å²ã€‚

---

## ä¸‰ã€é˜»å¡ vs å¼‚æ­¥ï¼šåšæŒåŒæ­¥é˜»å¡ï¼Œä½†ä¼˜åŒ–ä½“éªŒ

### ä¸ºä»€ä¹ˆä¸é€‰å¼‚æ­¥

CC V11 çš„å¼‚æ­¥ daemon æ¨¡å‹æœ‰ä¸€ä¸ªéšæ‚£ï¼šå²å®˜çš„å»ºè®®åˆ°è¾¾æ—¶ï¼Œä¸ç›¸å¯èƒ½å·²ç»å¼€å§‹ä¸‹ä¸€è½®äº†ã€‚å¦‚æœå²å®˜å‘ç°äº†ä¸¥é‡é—®é¢˜ï¼Œæ³¨å…¥çš„ advice ä¼šåœ¨ã€Œä¸‹ä¸‹è½®ã€æ‰ç”Ÿæ•ˆã€‚å¯¹äºä¸å¯é€†æ“ä½œï¼ˆæ–‡ä»¶åˆ é™¤ã€API è°ƒç”¨ï¼‰ï¼Œè¿™ä¸ªå»¶è¿Ÿæ˜¯è‡´å‘½çš„ã€‚

**åŒæ­¥é˜»å¡ = å²å®˜æœ‰å¦å†³æƒ**ã€‚è¿™æ˜¯åˆ¶åº¦è®¾è®¡ï¼Œä¸æ˜¯æ€§èƒ½é—®é¢˜ã€‚

### ä½“éªŒä¼˜åŒ–ï¼šæµå¼è¿›åº¦åé¦ˆ

é˜»å¡ä¸ä»£è¡¨ç”¨æˆ·çœ‹ç€é»‘å±ï¼š

```javascript
// agent_end hook ä¸­ï¼Œspawn å²å®˜åç«‹å³è¾“å‡ºè¿›åº¦
process.stdout.write('\n[å²å®˜å®¡æŸ¥ä¸­...]\n');

const historian = spawn('pi', [...]);

// æµå¼è¯»å–å²å®˜çš„æ€è€ƒè¿‡ç¨‹ï¼ˆå¦‚æœæ¨¡å¼æ”¯æŒï¼‰
historian.stdout.on('data', (chunk) => {
  const parsed = JSON.parse(chunk);
  if (parsed.type === 'thinking') {
    process.stdout.write(`  ğŸ“œ ${parsed.content}\n`);
  }
});

const advice = await collectFinalOutput(historian);
```

ç”¨æˆ·çœ‹åˆ°çš„æ˜¯å²å®˜åœ¨ã€Œå®æ—¶å®¡æŸ¥ã€ï¼Œè€Œä¸æ˜¯ç³»ç»Ÿå¡æ­»ã€‚å¿ƒç†ä½“éªŒå®Œå…¨ä¸åŒã€‚

---

## å››ã€å²å®˜çš„è¾“å‡ºå¤„ç†ï¼šåŒè·¯æ³¨å…¥

å²å®˜äº§ç”Ÿä¸¤ç§è¾“å‡ºï¼Œèµ°ä¸åŒçš„è·¯ï¼š

```javascript
async function processHistorianAdvice(ctx, advice) {
  if (!advice) return;
  
  // è·¯å¾„ Aï¼šæŒä¹…åŒ–è®°å½•ï¼ˆä¸è¿› LLM contextï¼‰
  await ctx.appendEntry({
    type: 'historian_record',
    severity: advice.severity,
    findings: advice.findings,
    timestamp: Date.now()
  });
  
  // è·¯å¾„ Bï¼šå¦‚æœæœ‰ actionable adviceï¼Œæ³¨å…¥ä¸‹ä¸€è½®
  if (advice.actionableAdvice && advice.severity >= 50) {
    await ctx.sendMessage({
      role: 'user',
      content: `[å²å®˜è¿›è¨€] ${advice.actionableAdvice}`,
      deliverAs: 'nextTurn'
    });
    
    // åŒæ—¶ä¿®æ”¹ä¸‹ä¸€è½® systemPrompt å¼ºè°ƒè¿™æ¡å»ºè®®
    ctx.pendingSystemPatch = `\n\nâš ï¸ å²å®˜æé†’: ${advice.actionableAdvice}`;
  }
  
  // è·¯å¾„ Cï¼šå¦‚æœå‘ç°ä¸¥é‡è¿è§„ï¼Œè§¦å‘ç´§æ€¥åœæ­¢
  if (advice.severity >= 90 && advice.requiresHalt) {
    throw new HistorianVetoError(advice.vetoReason);
    // Pi Extension çš„ agent_end æ˜¯é˜»å¡çš„ï¼ŒæŠ›å¼‚å¸¸å¯ä»¥é˜»æ­¢åç»­æµç¨‹
  }
}
```

**ä¸‰è·¯è¾“å‡º**ï¼šè®°å½•ï¼ˆappendEntryï¼‰ã€å»ºè®®ï¼ˆnextTurn æ³¨å…¥ï¼‰ã€å¦å†³ï¼ˆæŠ›å¼‚å¸¸ä¸­æ­¢ï¼‰ã€‚è¿™æ¯” CC V11 çš„å•ä¸€æ–‡ä»¶ä¸­è½¬æ›´æ¸…æ™°ã€‚

---

## äº”ã€ç»ˆç»“å²å®˜ï¼šsession_before_compact + æ˜¾å¼ç»ˆå®¡

ç”¨æˆ·è¯·æ±‚ç»“æŸæ—¶ï¼Œéœ€è¦ä¸€æ¬¡**ç»ˆå®¡**ï¼Œè¿™æ˜¯å²å®˜æœ€é‡è¦çš„ä¸€æ¬¡å·¥ä½œï¼š

```javascript
// session_before_compact hookï¼ˆPiï¼‰
hooks.on('session_before_compact', async (ctx) => {
  // æ— è®ºä¸¥é‡æ€§è¯„åˆ†å¦‚ä½•ï¼Œç»ˆå®¡å¼ºåˆ¶è§¦å‘
  const finalReview = await spawnHistorianFinalReview(ctx, {
    mode: 'final_audit',
    // ç»ˆå®¡è·å¾—æ›´å¤š contextï¼šå®Œæ•´çš„ appendEntry å†å²
    fullAuditLog: await readAllAppendEntries(),
    // ç»ˆå®¡å¯ä»¥ç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Š
    outputFormat: 'audit_report'
  });
  
  // ç»ˆå®¡æŠ¥å‘Šå†™å…¥æŒä¹…å­˜å‚¨
  await writeFile('.pi/court-audit-log.md', finalReview.report);
  
  // å¦‚æœç»ˆå®¡å‘ç°æœªè§£å†³é—®é¢˜ï¼Œæ³¨å…¥ compact åçš„ context
  if (finalReview.unresolvedIssues.length > 0) {
    ctx.compactedContextSuffix = buildUnresolvedIssueSummary(finalReview);
  }
});
```

`session_before_compact` æ˜¯å®Œç¾çš„ç»ˆå®¡æ—¶æœºï¼šå®ƒåœ¨ session ç»“æŸå‰è§¦å‘ï¼Œå¯ä»¥ä¿®æ”¹ compacted contextï¼Œç¡®ä¿ä¸‹ä¸€ä¸ª session ç»§æ‰¿æœªè§£å†³çš„é—®é¢˜ã€‚

---

## å…­ã€è·¨å¹³å°é€‚é…

### CC é€‚é…ï¼ˆé™çº§æ–¹æ¡ˆï¼‰

CC æ²¡æœ‰ `agent_end`ï¼Œç”¨ `SubagentStop` æ¨¡æ‹Ÿï¼Œä½†**æ”¾å¼ƒ daemon æ¨¡å¼**ï¼Œæ”¹ä¸ºæ¯æ¬¡ exit 2 é‡æ–°æ³¨å…¥æŒ‡ä»¤ï¼š

```bash
# SubagentStop hook (CC)
SEVERITY=$(compute_severity "$CLAUDE_TOOL_USE_HISTORY")
if [ "$SEVERITY" -ge 30 ]; then
  ADVICE=$(claude --no-session -p "$(build_historian_prompt)" < event_summary.json)
  echo "$ADVICE" >> pending-advice.md
  exit 2  # è§¦å‘é‡æ–°å®¡æŸ¥
fi
```

CC çš„å²å®˜æ— æ³•åšåˆ°çœŸæ­£çš„é›¶çŠ¶æ€ï¼ˆå› ä¸º SubagentStop å¤ç”¨äº† sessionï¼‰ï¼Œä½†é€šè¿‡ `--no-session` flag åˆ›å»ºéš”ç¦»çš„å®¡æŸ¥è¿›ç¨‹æ¥è¿‘ä¼¼ã€‚

### OC é€‚é…

OC çš„ `messages.transform` æ˜¯æœ€å¼ºçš„æ³¨å…¥ç‚¹ï¼Œå¯ä»¥åœ¨æ¯æ¬¡ API è°ƒç”¨å‰æŠŠå²å®˜çš„å†å²å»ºè®®æ³¨å…¥ï¼š

```typescript
// OC plugin
messages.transform((msgs) => {
  const pendingAdvice = readPendingAdvice(); // åŒæ­¥è¯»
  if (pendingAdvice) {
    // åœ¨æœ€åä¸€æ¡ user message å‰æ’å…¥å²å®˜å»ºè®®
    msgs.splice(-1, 0, {
      role: 'user',
      content: `[å²å®˜å†å²å»ºè®®å‚è€ƒ] ${pendingAdvice}`
    });
  }
  return msgs;
});
```

OC æ— æ³• spawn ç‹¬ç«‹è¿›ç¨‹ï¼Œæ‰€ä»¥å²å®˜çš„ã€Œå®¡æŸ¥ã€é€€åŒ–ä¸ºã€Œå»ºè®®æ³¨å…¥ã€ï¼Œç‹¬ç«‹æ€§æœ€å¼±ï¼Œä½†è‡³å°‘ä¿è¯äº†å»ºè®®çš„æŒç»­å¯è§æ€§ã€‚

---

## ä¸ƒã€æ–¹æ¡ˆæ€»ç»“ä¸é£é™©

### ä¼˜åŠ¿
1. **æ¡ä»¶è§¦å‘**é¿å…äº†å²å®˜å˜æˆæ©¡çš®å›¾ç« ï¼ˆæ–¹ A çš„é—®é¢˜ï¼‰
2. **é›¶çŠ¶æ€**ä¿è¯äº†å²å®˜çš„åˆ¶åº¦ç‹¬ç«‹æ€§ï¼ˆæ–¹ B çš„é—®é¢˜ï¼‰
3. **åŒæ­¥é˜»å¡**ç»™äº†å²å®˜çœŸæ­£çš„å¦å†³æƒï¼Œä¸æ˜¯äº‹åè¯¸è‘›äº®
4. **ä¸‰è·¯è¾“å‡º**ï¼ˆè®°å½•/å»ºè®®/å¦å†³ï¼‰æ¯”å•ä¸€æ–‡ä»¶ä¸­è½¬æ›´æ¸…æ™°
5. **ç»ˆå®¡æœºåˆ¶**ï¼ˆsession_before_compactï¼‰å¡«è¡¥äº† session ç»“æŸæ—¶çš„ç›‘ç£ç©ºç™½

### å·²çŸ¥é£é™©
1. **è¯„åˆ†å‡½æ•°å¯è¢«ç»•è¿‡**ï¼šå¦‚æœå·¥äººå­¦ä¼šäº†ç”¨ä½è¯„åˆ†çš„å·¥å…·åšé«˜é£é™©çš„äº‹ï¼Œå²å®˜ä¼šè¢«è·³è¿‡ã€‚ç¼“è§£ï¼šé”™è¯¯çŠ¶æ€å¼ºåˆ¶è§¦å‘ï¼ˆscore=100ï¼‰
2. **é˜»å¡å»¶è¿Ÿ**ï¼šé«˜é¢‘ä»»åŠ¡ä¸­ï¼Œæ¯æ¬¡å²å®˜å®¡æŸ¥å¢åŠ  1-3 ç§’å»¶è¿Ÿã€‚ç¼“è§£ï¼šè¯„åˆ†é˜ˆå€¼è°ƒä¼˜ + æµå¼è¿›åº¦åé¦ˆ
3. **ä¸Šä¸‹æ–‡åŒ…è®¾è®¡**ï¼šå¦‚æœ recentMessages æˆªå–ä¸å½“ï¼Œå²å®˜å¯èƒ½çœ‹ä¸åˆ°å…³é”®ä¿¡æ¯ã€‚ç¼“è§£ï¼šerror åœºæ™¯ä¼ æ›´å¤š context

**æ ¸å¿ƒç«‹åœº**ï¼šå²å®˜æ˜¯åˆ¶åº¦ï¼Œä¸æ˜¯å·¥å…·ã€‚åˆ¶åº¦è®¾è®¡çš„ç¬¬ä¸€åŸåˆ™æ˜¯ç‹¬ç«‹æ€§ï¼Œç¬¬äºŒåŸåˆ™æ˜¯æœ‰æ•ˆæ€§ï¼Œæ€§èƒ½æ˜¯ç¬¬ä¸‰ä½çš„ã€‚æ¡ä»¶è§¦å‘ + é›¶çŠ¶æ€ + åŒæ­¥é˜»å¡ï¼Œæ˜¯åœ¨è¿™ä¸‰ä¸ªåŸåˆ™ä¸‹çš„æœ€ä¼˜è§£ã€‚

---

## ç¬¬äºŒè½®ï¼šåé©³ä¸ä¿®æ­£

### Party A â€” åé©³ (gpt-5.2)

### 1) å…¶ä»–æ–¹æ¡ˆçš„å…·ä½“å¼±ç‚¹ä¸é£é™©

**å¯¹æ–¹ Bï¼ˆå¼‚æ­¥æ¡ä»¶è§¦å‘ + åˆ†å±‚å²å®˜ï¼‰ä¸»è¦é£é™©åœ¨â€œä¸€è‡´æ€§â€å’Œâ€œç¡¬çº¦æŸå¯ç»•è¿‡â€ï¼š**  
- **ä¼ªå¼‚æ­¥çš„æ—¶åºæ¼æ´**ï¼šç”¨ `sendMessage({deliverAs:"nextTurn"})` æŠŠå®¡æŸ¥æ¨åˆ°ä¸‹ä¸€è½®ï¼Œæœ¬è½®å·²ç»å‘ç”Ÿçš„å‰¯ä½œç”¨ï¼ˆå°¤å…¶æ˜¯ worker/minister çš„å†™æ–‡ä»¶ã€bashã€MCP å¤–éƒ¨è°ƒç”¨ï¼‰æ— æ³•è¢«å²å®˜â€œäº‹å‰å¦å†³â€ã€‚è¿™åœ¨ Court è®¾è®¡é‡Œç­‰äºå²å®˜ä»â€œå¸æ³•â€é€€åŒ–æˆâ€œå¤ç›˜â€ã€‚  
- **è½¯è§¦å‘é“¾æ¡è¿‡é•¿**ï¼šB ä¾èµ– context æ ‡è®° + before_agent_start å¼ºåˆ¶ +ï¼ˆå¯èƒ½ï¼‰å·¥å…·é™åˆ¶æ‰èƒ½é—­ç¯ã€‚ä»»ä½•ä¸€ä¸ªç¯èŠ‚æ¼æ‰“è¡¥ä¸ï¼Œå°±å¯èƒ½å‡ºç°â€œå¸¦ç€ historianPending ä¹Ÿç»§ç»­ delegate/æ‰§è¡Œâ€çš„é€ƒé€¸è·¯å¾„ã€‚  
- **Deep æ”¾åœ¨ `session_before_compact` çš„å®šä½ä¸ç¨³å®š**ï¼šå‹ç¼©å‰æ·±å®¡å¾ˆåˆ’ç®—ï¼Œä½†å®ƒæ›´åƒâ€œæ¡£æ¡ˆæ•´ç†/æ²»ç†â€ï¼Œå¹¶ä¸èƒ½è¦†ç›–â€œæœ¬è½®é«˜é£é™©åŠ¨ä½œçš„äº‹å‰å®¡åˆ¤â€ã€‚æŠŠæ·±å®¡å½“ä½œä¸»è¦ç›‘ç£ä¼šäº§ç”Ÿåˆ¶åº¦ç©ºçª—ã€‚

**å¯¹æ–¹ Cï¼ˆæ¡ä»¶è§¦å‘ + é›¶çŠ¶æ€ + åŒæ­¥é˜»å¡ï¼‰ä¸»è¦é£é™©åœ¨â€œè§¦å‘ç‚¹è¿‡æ™šâ€å’Œâ€œå¹³å°é€‚é…â€ï¼š**  
- **æŠŠæ ¸å¿ƒé€»è¾‘æ”¾åœ¨ `agent_end` ä»ç„¶æ˜¯â€œäº‹åå®¡åˆ¤â€**ï¼šåœ¨ Pi é‡Œ `agent_end` å‘ç”Ÿäºä¸€è½® loop ç»“æŸï¼›å¦‚æœè¿™ä¸€è½®å†…å·²ç»è°ƒç”¨è¿‡å†™å·¥å…·æˆ–å¤–éƒ¨å·¥å…·ï¼Œå²å®˜é˜»å¡ä¹Ÿåªèƒ½é˜»æ­¢â€œè¾“å‡ºç»™ç”¨æˆ·/è¿›å…¥ä¸‹ä¸€è½®â€ï¼Œä½†ä¸èƒ½æ’¤é”€å·²å‘ç”Ÿçš„å‰¯ä½œç”¨ã€‚  
- **severity è¯„åˆ†ä¾èµ–å¯è§‚æµ‹ä¿¡å·**ï¼šå¦‚æœæŸäº›é«˜é£é™©è¡Œä¸ºä¸åœ¨ `toolsUsed` é‡Œæ˜¾å¼å‘ˆç°ï¼ˆæˆ–ç”± minister/worker å†…éƒ¨é“¾è·¯å®Œæˆï¼‰ï¼Œè¯„åˆ†å¯èƒ½å¤±çœŸã€‚  
- **è·¨å¹³å° CC çš„ hook ç­‰ä»·æ€§ä¸è¶³**ï¼šCC çš„å¼ºé¡¹æ˜¯é€šè¿‡ PreToolUse/PostToolUse/Stop/SubagentStop åšâ€œè¿‡ç¨‹æ‹¦æˆªâ€ï¼›å¦‚æœä»ç„¶ä»¥â€œè½®æœ«å®¡æŸ¥â€ä¸ºä¸­å¿ƒï¼Œä¼šæµªè´¹ CC çš„ä¼˜åŠ¿ã€‚

---

### 2) æˆ‘çš„ç«‹åœºï¼šå²å®˜åº”â€œäº‹å‰æ‹¦æˆªä¸ºä¸»ã€è½®æœ«å®¡è®¡ä¸ºè¾…â€ï¼Œå¹¶ä¿æŒé›¶çŠ¶æ€

æˆ‘æ–¹ï¼ˆAï¼‰ä¸»å¼ æŠŠå²å®˜ä»â€œagent_end æ‰å‡ºç°çš„å®¡è®¡å‘˜â€å‡çº§ä¸º**ä¸¤æ®µå¼ç”Ÿå‘½å‘¨æœŸ**ï¼š

1) **Pre-Action Gateï¼ˆäº‹å‰é—¸é—¨ï¼‰**ï¼šåœ¨é«˜é£é™©å·¥å…·è°ƒç”¨å‰è§¦å‘å²å®˜å¿«é€Ÿå®¡åˆ¤ï¼Œå¿…è¦æ—¶ç›´æ¥å¦å†³æˆ–é™æƒï¼ˆè¿™æ˜¯åˆ¶åº¦æ„ä¹‰çš„ç›‘ç£ï¼‰ã€‚  
2) **Post-Turn Auditï¼ˆè½®æœ«å®¡è®¡ï¼‰**ï¼šåœ¨ `agent_end` åšä½é¢‘ã€æ¡ä»¶åŒ–çš„å¤æ ¸ä¸å½’æ¡£ï¼ˆé˜²æ¼ç½‘ã€åšæ²»ç†ï¼‰ã€‚

æ ¸å¿ƒç†ç”±ï¼š  
- **ä¸€è‡´æ€§**ï¼šåªæœ‰äº‹å‰æ‹¦æˆªï¼Œå²å®˜æ‰æœ‰çœŸå®å¦å†³æƒã€‚  
- **ç”¨æˆ·ä½“éªŒ**ï¼šäº‹å‰é—¸é—¨åªåœ¨â€œå°†è¦å‘ç”Ÿé«˜é£é™©åŠ¨ä½œâ€æ—¶çŸ­æš‚é˜»å¡ï¼›æ¯”â€œæ¯è½® agent_end ä¸€å¾‹é˜»å¡â€æ›´å¯æ¥å—ã€‚  
- **é›¶çŠ¶æ€**ï¼šå²å®˜è¿›ç¨‹æ¯æ¬¡ `spawn("pi", ["--no-session","--mode","json"])`ï¼Œåªåƒâ€œæœ€å°ä¸Šä¸‹æ–‡åŒ…â€ï¼Œä¿æŒç‹¬ç«‹æ€§ï¼ŒåŒæ—¶é€šè¿‡ appendEntry ç•™ä¸‹â€œåˆ¶åº¦æ€§æ¡£æ¡ˆâ€ã€‚

---

### 3) æ‰¿è®¤å¹¶æ•´åˆå¯¹æ–¹ä¼˜ç‚¹

- å¸æ”¶ **B çš„â€œåˆ†å±‚ï¼ˆLight/Deepï¼‰â€**ï¼šæˆ‘ä¹Ÿé‡‡ç”¨ Light/Deepï¼Œä½†**Light ç”¨äºäº‹å‰é—¸é—¨**ï¼ŒDeep ç”¨äºå‹ç¼©å‰æ²»ç†ä¸ç»ˆå®¡ã€‚  
- å¸æ”¶ **C çš„â€œæ¡ä»¶è§¦å‘è¯„åˆ†åˆ¶â€**ï¼šè¯„åˆ†ä¸æ˜¯æ”¾åœ¨ agent_end æ‰ç®—ï¼Œè€Œæ˜¯æ”¾åˆ°**æ¯æ¬¡å‡†å¤‡å¯ç”¨é«˜é£é™© tool å‰**ï¼Œå¹¶ä¸” agent_end ä»…åšâ€œè¡¥å®¡ + è®°å½•â€ã€‚

---

## 4) ä¿®è®¢åå®Œæ•´æ–¹æ¡ˆï¼ˆPi ä¸ºä¸»ï¼ŒCC/OC é€‚é…ï¼‰

### 4.1 è§¦å‘æ¡ä»¶ä¸ç”Ÿå‘½å‘¨æœŸï¼ˆPi Extensionï¼‰

**A. äº‹å‰é—¸é—¨ï¼ˆä¸»ç›‘ç£è·¯å¾„ï¼‰**  
- **Hook æ”¾ç½®**ï¼š`before_agent_start` + `context`ï¼ˆç”¨äºæ³¨å…¥è§„åˆ™ä¸æ ‡è®°ï¼‰ï¼Œé…åˆ **æºå¤´å·¥å…·é™åˆ¶** `setActiveTools()`ã€‚  
- **æœºåˆ¶**ï¼šå½“æ£€æµ‹åˆ°â€œæœ¬è½®è®¡åˆ’ä½¿ç”¨é«˜é£é™©å·¥å…·â€æ—¶ï¼Œä¸ç›¸å¿…é¡»å…ˆ delegate ç»™ Light Historianã€‚å®ç°ä¸Šä¸ä¾èµ– LLM è‡ªè§‰ï¼Œè€Œæ˜¯ç”¨å·¥å…·å¼€å…³ç¡¬å¡ã€‚

**å®ç°è¦ç‚¹ï¼ˆPiï¼‰**  
1) `context` äº‹ä»¶é‡Œåšé™æ€åˆ¤å®šï¼šè‹¥æœ€è¿‘æ¶ˆæ¯/çŠ¶æ€æ˜¾ç¤ºå³å°†æ‰§è¡Œå†™/å¤–éƒ¨è°ƒç”¨ï¼ˆä¾‹å¦‚ä¸Šä¸€è½® minister è¿”å›â€œéœ€è¦å†™æ–‡ä»¶/è·‘ bashâ€è®¡åˆ’ï¼‰ï¼Œå†™å…¥ `appendEntry({type:"risk_intent", ...})` å¹¶åœ¨æ¶ˆæ¯å°¾æ³¨å…¥ç»“æ„åŒ–æ ‡è®°ï¼ˆå¯è¢«ä¸ç›¸è¯»åˆ°ï¼‰ã€‚  
2) `before_agent_start`ï¼š  
   - è¯»å–æœ€è¿‘ `appendEntry` çš„ risk_intentï¼ˆé€šè¿‡ extension è‡ªå·±çš„å­˜å‚¨ï¼Œä¸è¿› LLM ä¸Šä¸‹æ–‡ï¼‰ã€‚  
   - è‹¥ risk_intent ä¸º trueï¼šå…ˆ `setActiveTools(["delegate","read"])`ï¼Œå¹¶è¡¥ä¸ systemPromptï¼š**â€œæœªè·å¾—å²å®˜æ”¾è¡Œä¸å¾—å¯ç”¨ä»»ä½•å†™/æ‰§è¡Œç±»å·¥å…·ã€‚â€**  
3) ä¸ç›¸ delegate å²å®˜ï¼ˆLightï¼‰åï¼Œç”± extension åœ¨ä¸‹ä¸€è½® `before_agent_start` æ£€æµ‹åˆ° â€œhistorian_allow=trueâ€ï¼ˆå†™å…¥ appendEntryï¼‰ï¼Œæ‰ `setActiveTools(["delegate","read", ...å…è®¸çš„å·¥å…·é›†åˆ...])`ã€‚

> è¿™é‡Œçš„å…³é”®æ˜¯ï¼š**ä¸æ˜¯æŠŠ advice æ³¨å…¥ä¸Šä¸‹æ–‡æ¥â€œåŠâ€ï¼Œè€Œæ˜¯ç”¨ `setActiveTools()` åšâ€œé—¸é—¨â€ã€‚** advice åªæ˜¯è§£é‡Šä¸å®¡è®¡è®°å½•ã€‚

**B. è½®æœ«å®¡è®¡ï¼ˆè¡¥ç›‘ç£è·¯å¾„ï¼‰**  
- **Hook æ”¾ç½®**ï¼š`agent_end`ï¼ˆæ¡ä»¶è§¦å‘ã€å¯é˜»å¡ä½†ä½é¢‘ï¼‰ã€‚  
- **è§¦å‘è§„åˆ™**ï¼š  
  - å¼ºåˆ¶ï¼šå‡ºç° error / tool å¼‚å¸¸ / è¶…é¢„ç®—ã€‚  
  - æ¡ä»¶ï¼šæœ¬è½®å®é™…å‘ç”Ÿé«˜é£é™© tool_useï¼ˆå†™ã€bashã€mcp_*ã€delegate é“¾è¿‡æ·±ï¼‰ã€‚  
  - å¦åˆ™è·³è¿‡ï¼Œä»… appendEntry è®°å½•â€œskipâ€ã€‚

**C. Deep / Final**  
- **Hook æ”¾ç½®**ï¼š`session_before_compact` åš Deepï¼ˆæ²»ç†+å‹ç¼©ç­–ç•¥æ ¡éªŒï¼‰ï¼›`agent_end` åœ¨æ£€æµ‹åˆ°â€œç”¨æˆ·æ˜ç¡®ç»“æŸ/å½’æ¡£è¯·æ±‚â€æ—¶åš Finalï¼ˆå¯è®¾ç½® 10-20s timeoutï¼Œé¿å…å¡æ­»ï¼‰ã€‚  
- Deep/Final äº§ç‰©åªå†™ appendEntry + ç”Ÿæˆå¯è¯»æŠ¥å‘Šæ–‡ä»¶ï¼›éœ€è¦æé†’ä¸ç›¸çš„éƒ¨åˆ†ç”¨ `sendMessage({deliverAs:"nextTurn"})` æ³¨å…¥ã€‚

### 4.2 çŠ¶æ€ç®¡ç†

- **å²å®˜é›¶çŠ¶æ€**ï¼šæ¯æ¬¡ `spawn("pi", ["--no-session","--mode","json"])`ã€‚  
- **åˆ¶åº¦æ€§è®°å¿†**ï¼šè§„åˆ™ã€å·¥å…·çŸ©é˜µã€ä¹å¿ç”»åƒæ”¾åªè¯»æ–‡ä»¶ï¼›å®¡æŸ¥è®°å½•ç”¨ `appendEntry()` æŒä¹…åŒ–ï¼Œä½†é»˜è®¤ä¸è¿› LLM contextã€‚  
- **æœ€å°ä¸Šä¸‹æ–‡åŒ…**ï¼šåªç»™å²å®˜ï¼šé£é™©æ„å›¾ã€æœ€è¿‘ N æ¡æ¶ˆæ¯ã€æœ€è¿‘ K æ¡å®¡æŸ¥æ‘˜è¦ã€å³å°†å¯ç”¨çš„å·¥å…·é›†åˆ/ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆè‹¥æœ‰ï¼‰ã€‚

### 4.3 ç»ˆç»“æœºåˆ¶ï¼ˆPiï¼‰

- Pi æ²¡æœ‰ CC çš„ Stop hookï¼Œæˆ‘æ–¹ç”¨ä¸¤çº§å…œåº•ï¼š  
  1) **æ˜¾å¼ç»ˆç»“**ï¼šå½“ç”¨æˆ·è¯´â€œç»“æŸ/æ€»ç»“/å½’æ¡£â€ï¼Œåœ¨ `before_agent_start` æ£€æµ‹åˆ°æ„å›¾ï¼Œå¼ºåˆ¶æ‰“å¼€ Final Gateï¼ˆåŒæ ·ç”¨ `setActiveTools(["delegate","read"])` å…ˆå®¡å†æ”¾è¡Œè¾“å‡ºæ€»ç»“ï¼‰ã€‚  
  2) **å‹ç¼©å‰ç»ˆå®¡**ï¼š`session_before_compact` æ°¸è¿œè·‘ä¸€æ¬¡ Deepï¼ˆå¯é™çº§ä¸ºâ€œä»…ç”Ÿæˆ compact é™„æ³¨â€ï¼‰ï¼ŒæŠŠæœªè§£å†³é£é™©å†™å…¥ compact åçš„ç³»ç»Ÿé™„å½•ï¼ˆé€šè¿‡è‡ªå®šä¹‰å‹ç¼©é€»è¾‘å®ç°ï¼‰ã€‚

### 4.4 è·¨å¹³å°é€‚é…

**CCï¼ˆClaude Code Hooksï¼‰**  
- æŠŠâ€œäº‹å‰é—¸é—¨â€æ˜ å°„åˆ° **PreToolUse updatedInput**ï¼šå½“æ£€æµ‹å°†è°ƒç”¨é«˜é£é™©å·¥å…·æ—¶ï¼ŒPreToolUse æŠŠ task prompt æ”¹å†™ä¸ºâ€œå…ˆè¿è¡Œ historian å­ä»»åŠ¡â€ï¼›å¹¶ç”¨ **Stop hook exit 2** ä¿è¯æœªå®¡æŸ¥ä¸å…è®¸åœæ­¢ã€‚  
- å²å®˜ä»ç”¨ Sub-Agent Taskï¼ˆéš”ç¦» contextï¼‰ï¼Œè¾“å‡ºå†™ `pending-advice.md`ï¼Œå†é€šè¿‡ **PostToolUse exit 2 stderr æ³¨å…¥**å›çˆ¶ä¸Šä¸‹æ–‡ã€‚  
- ä¸é‡‡ç”¨ V11 çš„ historian daemon è‡ªå¾ªç¯ï¼ˆå‡å°‘çŠ¶æ€æ±¡æŸ“ä¸ hook é“¾å¤æ‚åº¦ï¼‰ï¼›åªåœ¨é«˜é£é™©å‰è§¦å‘çŸ­ä»»åŠ¡ã€‚

**OCï¼ˆOpenCodeï¼‰**  
- è‹¥å¯ç”¨ `task(run_in_background=true)`ï¼šæŠŠ Light Historianåšæˆåå°ï¼Œä½†**åªç”¨äºä½é£é™©æé†’**ï¼›é«˜é£é™©ä»å»ºè®®åŒæ­¥ï¼ˆå¦åˆ™ä¸€è‡´æ€§ä¸è¶³ï¼‰ã€‚  
- ä½¿ç”¨ `messages.transform` åšâ€œé—¸é—¨æç¤º + æ³¨å…¥ pending adviceâ€ï¼Œä½† OC ä¸èƒ½ç¡¬æ€§ `setActiveTools`ï¼Œå› æ­¤åœ¨ OC ä¸Šé—¸é—¨åªèƒ½åšåˆ°â€œå¼ºæç¤º + å¤±è´¥å³ä¸­æ­¢â€çš„è½¯ç¡¬ç»“åˆï¼ˆæ‰¿è®¤é™çº§ï¼‰ã€‚

### 4.5 Token æˆæœ¬ä¸æ€§èƒ½

- **æ¯”â€œæ¯è½® agent_end éƒ½å®¡â€çœ**ï¼šå¤šæ•°çº¯ read/delegate åˆ†è§£è½®æ¬¡ä¸ä¼šè§¦å‘å²å®˜ã€‚  
- **æ¯”â€œå¼‚æ­¥ daemonâ€ç¨³**ï¼šæ²¡æœ‰å¸¸é©»ç©ºè½¬æˆæœ¬ï¼Œä¹Ÿæ²¡æœ‰ advice å»¶è¿Ÿå¯¼è‡´çš„è¿”å·¥æˆæœ¬ã€‚  
- Light Historian é¢„ç®—æ§åˆ¶åœ¨ **600-1200 tokens**ï¼ˆæœ€å°ä¸Šä¸‹æ–‡åŒ…ï¼‰ï¼Œåªåœ¨â€œå°†å‘ç”Ÿå‰¯ä½œç”¨â€æ—¶è§¦å‘ï¼›Deep/Final ä½é¢‘ä½†å¯ç”¨æ›´å¤§çª—å£ï¼ˆå‹ç¼©å‰ï¼‰æ¢æ›´é«˜ä»·å€¼ã€‚

---

**ç»“è®º**ï¼šæˆ‘æ–¹ä¿®è®¢æ–¹æ¡ˆæŠŠå²å®˜ç”Ÿå‘½å‘¨æœŸæ‹†æˆâ€œäº‹å‰é—¸é—¨ + è½®æœ«è¡¥å®¡ + å‹ç¼©å‰æ·±å®¡/ç»ˆå®¡â€ï¼Œç”¨ Pi çš„ `setActiveTools()` æŠŠç›‘ç£ä»â€œå»ºè®®â€å‡çº§ä¸ºâ€œåˆ¶åº¦æ‰§è¡Œâ€ï¼ŒåŒæ—¶ä¿æŒå²å®˜é›¶çŠ¶æ€ä¸è·¨å¹³å°å¯é™çº§å®ç°ã€‚

---

### Party B â€” åé©³ (kimi-k2.5)

## æ–¹ Bï¼šå²å®˜çš„ã€Œå¼‚æ­¥è„‰å†² + ç»ˆå±€æ”¶æ•›ã€æ¨¡å‹

### æ ¸å¿ƒä¸»å¼ 

**å²å®˜åº”å½“æ˜¯"å¼‚æ­¥å®ˆæœ›è€… + ç»ˆå±€å®ˆé—¨äºº"çš„åŒé‡è§’è‰²ï¼Œè€Œéæ¯è½®é˜»å¡çš„å®¡åˆ¤å‘˜æˆ–å¸¸é©»çš„ daemonã€‚Pi çš„ `agent_end` é˜»å¡æ˜¯ä½“éªŒæ¯’è¯ï¼ŒCC V11 çš„ daemon è‡ªå¾ªç¯æ˜¯æ¶æ„å€ºåŠ¡â€”â€”çœŸæ­£çš„è§£æ³•æ˜¯ï¼šç”¨ Pi çš„ `context` äº‹ä»¶åšè½»é‡é¢„åˆ¤ï¼Œ`sendMessage(nextTurn)` å®ç°å¼‚æ­¥è¿›è¨€ï¼Œ`session_before_compact` åšç»ˆå±€å¼ºåˆ¶å®¡è®¡ã€‚**

---

## ä¸€ã€å¯¹æ–¹æ¡ˆ A å’Œ C çš„æ ¸å¿ƒæ‰¹åˆ¤

### æ–¹æ¡ˆ Aï¼ˆgpt-5.2ï¼‰çš„é—®é¢˜ï¼š**è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œæ¨¡ç³Šäº†åˆ¶åº¦è¾¹ç•Œ**

æ–¹ A çš„"åŒé€šé“è§¦å‘"ï¼ˆFast Historian + Deep Historianï¼‰çœ‹ä¼¼çµæ´»ï¼Œå®åˆ™ç ´åäº†æœå»·æ¶æ„çš„æ ¹æœ¬åŸåˆ™ï¼š

| é—®é¢˜ | å…·ä½“è¡¨ç° |
|------|---------|
| **ä¸ç›¸ä¸å†è¶…ç„¶** | Fast Historian åœ¨ `context` äº‹ä»¶é‡Œè¿è¡Œï¼Œæ„å‘³ç€ä¸ç›¸æ¯è½®éƒ½è¦å‚ä¸"è¦ä¸è¦å®¡æŸ¥"çš„åˆ¤å®šé€»è¾‘ï¼Œä» pure supervisor å˜æˆäº† decision maker |
| **çŠ¶æ€æ³„æ¼é£é™©** | `turnMeta` ç»´æŠ¤åœ¨ extension state ä¸­ï¼Œä¸ç›¸ä¸å²å®˜çš„è¾¹ç•Œè¢« `reviewLevel` è®¡ç®—é€»è¾‘ç©¿é€ |
| **å¼‚æ­¥ä¸€è‡´æ€§å¹»è§‰** | `sendMessage(nextTurn)` + `before_agent_start` æ³¨å…¥çœ‹ä¼¼å¼‚æ­¥ï¼Œä½† advice çš„ `turnId/planHash` æ ¡éªŒéœ€è¦ä¸ç›¸ä¸»åŠ¨ Ackâ€”â€”è¿™åˆå›åˆ°äº†è½¯çº¦æŸ |

**æ ¹æœ¬çŸ›ç›¾**ï¼šæ–¹ A æƒ³è®©å²å®˜"æ— å¤„ä¸åœ¨åˆä¸å¤ªæ‰“æ‰°"ï¼Œç»“æœè®©ä¸ç›¸æ‰¿æ‹…äº†æœ¬ä¸è¯¥æ‰¿æ‹…çš„è°ƒåº¦èŒè´£ã€‚

### æ–¹æ¡ˆ Cï¼ˆclaude-sonnet-4-6ï¼‰çš„é—®é¢˜ï¼š**åŒæ­¥é˜»å¡æ˜¯ä½“éªŒç¾éš¾ï¼Œè¯„åˆ†å‡½æ•°æ˜¯è„†å¼±ä¸­å¿ƒ**

æ–¹ C çš„"ä¸¥é‡æ€§è¯„åˆ†åˆ¶"æœ‰ä¸€ä¸ªè‡´å‘½å‡è®¾ï¼š**è¯„åˆ†å‡½æ•°èƒ½å‡†ç¡®é¢„åˆ¤å“ªäº›æ“ä½œéœ€è¦å®¡æŸ¥**ã€‚è¿™åœ¨å®è·µä¸­ä¸å¯è¡Œï¼š

```javascript
// æ–¹ C çš„è¯„åˆ†å‡½æ•°æ¼æ´ç¤ºä¾‹
// åœºæ™¯ï¼šå·¥äººç”¨ read å·¥å…·è¯»å– .env æ–‡ä»¶ï¼Œç„¶åæ‹¼æ¥æˆ curl å‘½ä»¤é€šè¿‡ bash å¤–æ³„
// å•çœ‹å·¥å…·ï¼šread (5åˆ†) + bash (40åˆ†) = 45åˆ†ï¼Œå¯èƒ½ä½äºé˜ˆå€¼
// å®é™…é£é™©ï¼šæ•°æ®æ³„éœ²ï¼Œä¸¥é‡è¿è§„
```

æ›´ä¸¥é‡çš„æ˜¯**é˜»å¡ä½“éªŒ**ï¼š

> ç”¨æˆ·é—®ï¼š"å¸®æˆ‘æŸ¥ä¸€ä¸‹ä»Šå¤©çš„å¤©æ°”" â†’ ä¸ç›¸ delegate ç»™å·¥äºº â†’ agent_end â†’ å²å®˜ spawn â†’ 3ç§’é˜»å¡ â†’ "severity=25, skip" â†’ ç”¨æˆ·çœ‹åˆ°å»¶è¿Ÿï¼Œæ¯«æ— ä»·å€¼

æ–¹ C çš„"æµå¼è¿›åº¦åé¦ˆ"æ˜¯å¿ƒç†å®‰æ…°ï¼Œä¸æ˜¯æŠ€æœ¯è§£å†³ã€‚LLM è°ƒç”¨æœ¬èº«çš„ latency æ— æ³•æ¶ˆé™¤ã€‚

---

## äºŒã€æˆ‘çš„æ–¹æ¡ˆï¼šå¼‚æ­¥è„‰å†² + ç»ˆå±€æ”¶æ•›

### æ ¸å¿ƒæœºåˆ¶ï¼ˆPi å¹³å°ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸ç›¸ä¸»è¿›ç¨‹ (Chancellor)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ çº¯ç›‘ç£ï¼šread + delegate only                          â”‚
â”‚  â€¢ ä¸æ‰§è¡Œä»»ä½• write/bash/mcp å·¥å…·                        â”‚
â”‚                                                           â”‚
â”‚  Hook åˆ†å·¥ï¼š                                               â”‚
â”‚  â”œâ”€ context: ç”Ÿæˆ audit packet, è®°å½•åˆ° appendEntry        â”‚
â”‚  â”œâ”€ before_agent_start: æ£€æŸ¥æ˜¯å¦æœ‰ pending advice         â”‚
â”‚  â”œâ”€ agent_end: ã€éé˜»å¡ã€‘æ ‡è®°æœ¬è½®ä¸º"å¾…å®¡"æˆ–"å·²å®¡"          â”‚
â”‚  â””â”€ session_before_compact: ã€å¼ºåˆ¶é˜»å¡ã€‘ç»ˆå®¡å²å®˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å²å®˜å­è¿›ç¨‹ (Historian) â€”â€” é›¶çŠ¶æ€ï¼Œæ¯æ¬¡å…¨æ–° spawn          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  è§¦å‘æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰ï¼š                                     â”‚
â”‚  1. æœ¬è½®äº§ç”Ÿ write/edit/bash/mcp ç­‰å‰¯ä½œç”¨å·¥å…·              â”‚
â”‚  2. æœ¬è½®å‡ºç° error / exception                           â”‚
â”‚  3. ç”¨æˆ·æ˜ç¡®è¡¨è¾¾ä¸æ»¡/å›°æƒ‘                                 â”‚
â”‚  4. session_before_compactï¼ˆç»ˆå±€å¼ºåˆ¶ï¼‰                    â”‚
â”‚                                                           â”‚
â”‚  è¾“å…¥ï¼šaudit packetï¼ˆç»“æ„åŒ–ï¼Œéå®Œæ•´å¯¹è¯ï¼‰                   â”‚
â”‚  è¾“å‡ºï¼š                                                   â”‚
â”‚    â€¢ appendEntry: æ°¸ä¹…å®¡è®¡è®°å½•                             â”‚
â”‚    â€¢ sendMessage(nextTurn): å»ºè®®æ³¨å…¥ä¸‹ä¸€è½®                 â”‚
â”‚    â€¢ ï¼ˆä¸¥é‡ï¼‰ä¿®æ”¹ systemPrompt ä¸‹è½®å¼ºåˆ¶å¤„ç†                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è®¾è®¡ï¼šagent_end ä¸é˜»å¡ï¼Œä½†ä¿è¯"ç»ˆå±€å¿…å®¡"

```javascript
// agent_end hook â€”â€” éé˜»å¡ï¼Œä»…æ ‡è®°
hooks.on('agent_end', async (ctx) => {
  const needsReview = checkNeedsReview(ctx); // ç®€å•è§„åˆ™ï¼Œæ— å¤æ‚è¯„åˆ†
  
  await ctx.appendEntry({
    type: 'turn_mark',
    turnId: ctx.turnId,
    needsReview,
    toolsUsed: ctx.toolsUsed,
    timestamp: Date.now()
  });
  
  if (needsReview) {
    // ã€å…³é”®ã€‘ä¸é˜»å¡ï¼Œåå° spawnï¼Œç»“æœè¿› nextTurn
    spawnHistorianAsync(ctx).catch(console.error);
  }
});

// session_before_compact â€”â€” å¼ºåˆ¶é˜»å¡ï¼Œç»ˆå®¡
hooks.on('session_before_compact', async (ctx) => {
  const unreviewedTurns = await getUnreviewedTurns();
  
  // æ— è®ºä¹‹å‰å®¡è¿‡å¤šå°‘ï¼Œç»ˆå±€å¿…é¡»æœ‰ä¸€æ¬¡å®Œæ•´å®¡è®¡
  const finalAdvice = await spawnHistorianSync(ctx, {
    mode: 'final_audit',
    scope: 'full_session',
    unreviewedTurns // é‡ç‚¹å®¡è®¡æœªå®¡å›åˆ
  });
  
  // ç»ˆå®¡ç»“æœå†™å…¥ compacted context çš„ metadata
  ctx.compactMetadata = {
    ...ctx.compactMetadata,
    finalAudit: finalAdvice.summary,
    unresolvedIssues: finalAdvice.unresolved
  };
});
```

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

| ç»´åº¦ | æˆ‘çš„æ–¹æ¡ˆ | æ–¹ C å¯¹æ¯” |
|------|---------|----------|
| **æ—¥å¸¸ä½“éªŒ** | æ— é˜»å¡ï¼Œç”¨æˆ·å³æ—¶çœ‹åˆ°è¾“å‡º | æ¯è½®æ½œåœ¨ 1-3 ç§’å»¶è¿Ÿ |
| **å®‰å…¨åº•çº¿** | ç»ˆå±€å¼ºåˆ¶å®¡è®¡ï¼Œæœªè§£å†³é—®é¢˜å¸¦å…¥ä¸‹ä¸€è½® | ä¾èµ–è¯„åˆ†å‡½æ•°ä¸æ¼åˆ¤ |
| **å²å®˜ç‹¬ç«‹æ€§** | é›¶çŠ¶æ€ spawnï¼Œæ—  daemon æ±¡æŸ“ | ç›¸åŒ |
| **ä¸ç›¸çº¯ç²¹æ€§** | å®Œå…¨ä¸å‚ä¸"è¦ä¸è¦å®¡"çš„å†³ç­– | ç›¸åŒ |
| **ä¸€è‡´æ€§ä¿è¯** | `session_before_compact` æ˜¯ç¡¬è¾¹ç•Œ | `agent_end` é˜»å¡æ˜¯è½¯è¾¹ç•Œ |

---

## ä¸‰ã€æ‰¿è®¤å¹¶æ•´åˆå¯¹æ–¹ä¼˜ç‚¹

### ä»æ–¹ A å¸æ”¶ï¼š`context` äº‹ä»¶çš„ audit packet ç”Ÿæˆ

æ–¹ A çš„ audit packet æœ€å°åŒ–æ€è·¯æ˜¯æ­£ç¡®çš„ã€‚æˆ‘é‡‡ç”¨ç®€åŒ–ç‰ˆï¼š

```javascript
// context hook â€”â€” ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦ï¼Œä¸è¿› LLM context
hooks.on('context', async (messages) => {
  const auditPacket = {
    turnId: generateId(),
    role: process.env.PI_COURT_ROLE,
    userIntent: extractUserIntent(messages),
    actions: extractToolCalls(messages), // åªæå–å·¥å…·è°ƒç”¨ï¼Œä¸ä¼  full message
    risks: tagRisks(messages), // é¢„æ‰“æ ‡ç­¾ï¼Œä¾›å²å®˜å‚è€ƒ
    planDelta: computePlanChange(messages) // è®¡åˆ’å˜æ›´æ‘˜è¦
  };
  
  // å­˜å…¥ extension stateï¼Œä¾›åç»­ hooks ä½¿ç”¨ï¼Œä½†ä¸è¿› messages
  globalThis.currentAuditPacket = auditPacket;
  
  return messages; // ä¸ä¿®æ”¹ï¼Œä¿æŒé€æ˜
});
```

### ä»æ–¹ C å¸æ”¶ï¼šä¸‰è·¯è¾“å‡ºè®¾è®¡

æ–¹ C çš„"è®°å½•/å»ºè®®/å¦å†³"åˆ†ç¦»æ˜¯å¥½çš„ï¼Œä½†æˆ‘è°ƒæ•´è§¦å‘æ–¹å¼ï¼š

```javascript
async function processHistorianOutput(ctx, output) {
  // è·¯å¾„ Aï¼šæ°¸ä¹…è®°å½•ï¼ˆå§‹ç»ˆï¼‰
  await ctx.appendEntry({
    type: 'historian_record',
    ...output.findings
  });
  
  // è·¯å¾„ Bï¼šå»ºè®®æ³¨å…¥ï¼ˆå¸¸è§„ï¼‰
  if (output.advice && output.severity < 80) {
    await ctx.sendMessage({
      role: 'user', // ä¼ªè£…ç”¨æˆ·è¿›è¨€ï¼Œæ›´è‡ªç„¶
      content: `[å²å®˜] ${output.advice}`,
      deliverAs: 'nextTurn'
    });
  }
  
  // è·¯å¾„ Cï¼šç´§æ€¥å¹²é¢„ï¼ˆä¸¥é‡ï¼Œä¿®æ”¹ä¸‹è½® systemPromptï¼‰
  if (output.severity >= 80) {
    ctx.pendingSystemPatch = `
âš ï¸ å²å®˜ç´§æ€¥æé†’ï¼šä¸Šè½®æ“ä½œå­˜åœ¨ä¸¥é‡é£é™©
[${output.vetoReason}]

ä½ å¿…é¡»ï¼š
1. å…ˆå‘ç”¨æˆ·è¯´æ˜æƒ…å†µ
2. ç­‰å¾…ç”¨æˆ·ç¡®è®¤åå†ç»§ç»­
`;
    // åŒæ—¶é€šè¿‡ sendMessage ç¡®ä¿å¯è§
    await ctx.sendMessage({
      role: 'user',
      content: `[å²å®˜ç´§æ€¥] ${output.vetoReason}ï¼Œè¯·ç¡®è®¤æ˜¯å¦ç»§ç»­`,
      deliverAs: 'nextTurn'
    });
  }
}
```

**å…³é”®å·®å¼‚**ï¼šæ–¹ C åœ¨ `agent_end` æŠ›å¼‚å¸¸é˜»å¡ï¼Œæˆ‘åœ¨ `before_agent_start` ä¿®æ”¹ systemPrompt å¼ºåˆ¶å¤„ç†â€”â€”åŒæ ·è¾¾åˆ°"ä¸‹è½®å¿…é¡»å…ˆå¤„ç†"çš„æ•ˆæœï¼Œä½†ä¸é˜»å¡æœ¬è½®ç”¨æˆ·ä½“éªŒã€‚

---

## å››ã€è·¨å¹³å°é€‚é…

### CC å¹³å°ï¼šæ”¾å¼ƒ daemonï¼Œç”¨ SubagentStop æ¨¡æ‹Ÿ"è„‰å†²"

CC æ²¡æœ‰ `session_before_compact`ï¼Œä½†æœ‰ `Stop` hook å…œåº•ï¼š

```bash
# SessionStart: åˆå§‹åŒ–ç©ºçŠ¶æ€
echo '{"unreviewed": []}' > .pi/court-state.json

# SubagentStop: æ ‡è®°å¾…å®¡ï¼ˆéé˜»å¡ï¼‰
if [ "$CLAUDE_EXIT_CODE" -eq 0 ]; then
  # æ­£å¸¸ç»“æŸï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æŸ¥
  if needs_review "$CLAUDE_TOOL_USE_HISTORY"; then
    echo "{\"turn\": \"$CLAUDE_TURN_ID\", \"status\": \"pending\"}" >> .pi/unreviewed.jsonl
  fi
fi
exit 0  # ä¸é˜»æ­¢åœæ­¢ï¼Œè®©æµç¨‹ç»§ç»­

# Stop hook: ç»ˆå±€å¼ºåˆ¶å®¡è®¡
if [ -s .pi/unreviewed.jsonl ]; then
  FINAL_AUDIT=$(claude --no-session -p "$(cat .pi/final-audit-prompt.md)" < .pi/unreviewed.jsonl)
  echo "$FINAL_AUDIT" > .pi/final-audit.md
  # æ³¨å…¥åˆ° additionalContext ä¾›ä¸‹æ¬¡å¯åŠ¨
  echo "$FINAL_AUDIT" >> .pi/next-session-context.md
fi
```

CC çš„å²å®˜æ— æ³•å®Œå…¨å¼‚æ­¥ï¼Œä½†é€šè¿‡"æ ‡è®°å¾…å®¡ + ç»ˆå±€æ‰¹é‡å®¡è®¡"è¿‘ä¼¼æˆ‘çš„æ¨¡å‹ã€‚

### OC å¹³å°ï¼š`messages.transform` + `task` èƒŒæ™¯ä»»åŠ¡

```typescript
// OC: åˆ©ç”¨ task(run_in_background=true) åšå¼‚æ­¥å²å®˜
const historianTask = {
  name: 'court-historian',
  run_in_background: true,
  on_trigger: 'after_tool_use',
  condition: (ctx) => hasSideEffect(ctx.toolsUsed),
  action: async (ctx) => {
    const advice = await callHistorianAPI(buildAuditPacket(ctx));
    await savePendingAdvice(advice); // å†™å…¥ .pi/pending-advice.md
  }
};

// messages.transform: æ³¨å…¥ pending advice
messages.transform((msgs) => {
  const pending = readPendingAdviceSync(); // åŒæ­¥è¯»
  if (pending) {
    clearPendingAdvice(); // åŸå­è¯»æ¸…
    msgs.push({
      role: 'user',
      content: `[å²å®˜] ${pending}`
    });
  }
  return msgs;
});
```

OC çš„é™åˆ¶æ˜¯æ— æ³•çœŸæ­£ spawn éš”ç¦»è¿›ç¨‹ï¼Œå²å®˜é€€åŒ–ä¸º API è°ƒç”¨ï¼Œä½†åè®®å±‚é¢ä¿æŒä¸€è‡´ã€‚

---

## äº”ã€ä¿®è®¢åå®Œæ•´æ–¹æ¡ˆ

| ç»„ä»¶ | æœºåˆ¶ | å¹³å°å·®å¼‚ |
|------|------|---------|
| **è§¦å‘æ¡ä»¶** | å‰¯ä½œç”¨å·¥å…· / error / ç”¨æˆ·ä¸æ»¡ / ç»ˆå±€å¼ºåˆ¶ | Pi: `agent_end` æ ‡è®°ï¼›CC: `SubagentStop` æ ‡è®°ï¼›OC: `task` è§¦å‘ |
| **è¿è¡Œæ¨¡å¼** | é›¶çŠ¶æ€ spawnï¼Œå•æ¬¡è„‰å†² | ç»Ÿä¸€ |
| **é˜»å¡ç­–ç•¥** | é»˜è®¤å¼‚æ­¥ï¼Œä»… `session_before_compact` / `Stop` é˜»å¡ | Pi/CC æœ‰ç»ˆå±€é˜»å¡ï¼ŒOC æ—  |
| **è¾“å‡ºå¤„ç†** | appendEntry(è®°å½•) + sendMessage/nextTurn(å»ºè®®) + systemPatch(ç´§æ€¥) | Pi åŸç”Ÿæ”¯æŒï¼›CC ç”¨ pending-advice.mdï¼›OC ç”¨ transform |
| **ä¸€è‡´æ€§ä¿è¯** | ç»ˆå±€å®¡è®¡ + unresolved issues å¸¦å…¥ä¸‹ä¸€è½® | ç»Ÿä¸€ |

### Token æˆæœ¬ä¼°ç®—

- **æ—¥å¸¸å›åˆ**ï¼š0 tokenï¼ˆæ— å²å®˜è°ƒç”¨ï¼‰vs æ–¹ C çš„ 500-1500 token/è½®
- **æœ‰é£é™©å›åˆ**ï¼š~800 tokenï¼ˆaudit packet ç²¾ç®€ï¼‰vs æ–¹ C çš„ 1500-3000 tokenï¼ˆå®Œæ•´ä¸Šä¸‹æ–‡é‡å»ºï¼‰
- **ç»ˆå±€å®¡è®¡**ï¼š~2000 tokenï¼ˆå…¨ session æ‘˜è¦ï¼‰ï¼Œä½†é¢‘ç‡æä½ï¼ˆæ¯ session ä¸€æ¬¡ï¼‰

**ç»“è®º**ï¼šæˆ‘çš„æ–¹æ¡ˆåœ¨ä¿éšœå®‰å…¨åº•çº¿çš„å‰æä¸‹ï¼Œå°†å²å®˜è°ƒç”¨é¢‘ç‡ä»"æ¯è½®æ½œåœ¨è§¦å‘"é™è‡³"çœŸæ­£æœ‰é£é™©çš„å›åˆ + ç»ˆå±€å¼ºåˆ¶"ï¼Œtoken æ•ˆç‡æœ€ä¼˜ã€‚

---

## æœ€ç»ˆç«‹åœº

å²å®˜çš„åˆ¶åº¦ä»·å€¼åœ¨äº**ç‹¬ç«‹ç›‘ç£**ï¼Œè€Œé**å®æ—¶æ‹¦æˆª**ã€‚æ–¹ C çš„åŒæ­¥é˜»å¡è®©å²å®˜å˜æˆäº†"ä»£ç å®¡æŸ¥ä¸­çš„ CI å¡ç‚¹"ï¼Œæ–¹ A çš„åŒé€šé“è®©ä¸ç›¸æ‰¿æ‹…äº†æœ¬ä¸è¯¥æ‰¿æ‹…çš„è°ƒåº¦èŒè´£ã€‚æˆ‘çš„æ–¹æ¡ˆï¼š**å¼‚æ­¥è„‰å†²ä¿è¯ä½“éªŒï¼Œç»ˆå±€æ”¶æ•›ä¿è¯åº•çº¿ï¼Œé›¶çŠ¶æ€ä¿è¯ç‹¬ç«‹**â€”â€”è¿™æ‰æ˜¯"æœå»·æ¶æ„"åº”æœ‰çš„æ²»ç†æ™ºæ…§ã€‚

---

### Party C â€” åé©³ (claude-sonnet-4-6)

# æ–¹ C å›åº”ï¼šã€Œç¡®å®šæ€§è§¦å‘ + ç¡¬çº¦æŸå¼ºåˆ¶ + æœ€å°å¤æ‚åº¦ã€

## æ ¸å¿ƒä¸»å¼ 

**æ–¹ A å’Œæ–¹ B éƒ½çŠ¯äº†åŒä¸€ä¸ªé”™è¯¯ï¼šç”¨å¤æ‚çš„è½¯çº¦æŸç³»ç»Ÿå»è§£å†³ä¸€ä¸ªå¯ä»¥ç”¨ç®€å•ç¡¬çº¦æŸè§£å†³çš„é—®é¢˜ã€‚**

ä¸¤æ–¹éƒ½å¼•å…¥äº†æ¡ä»¶è§¦å‘é€»è¾‘ã€åˆ†å±‚å²å®˜ã€ä¼ªå¼‚æ­¥æ ‡è®°æ¶ˆæ¯ã€planHash æ ¡éªŒç­‰æœºåˆ¶â€”â€”è¿™äº›éƒ½æ˜¯è½¯çº¦æŸï¼Œéƒ½å¯ä»¥è¢«ç»•è¿‡ã€è¢«é—å¿˜ã€æˆ–åœ¨è¾¹ç•Œæƒ…å†µä¸‹å¤±æ•ˆã€‚æˆ‘çš„æ–¹æ¡ˆæ›´ç®€å•ï¼Œæ›´ç¡®å®šï¼Œæ›´éš¾å‡ºé”™ã€‚

---

## ä¸€ã€å¯¹æ–¹æ¡ˆ A å’Œ B çš„å…·ä½“æ‰¹è¯„

### æ–¹ A çš„å¼±ç‚¹ï¼šè¿‡åº¦å·¥ç¨‹åŒ–çš„å¼‚æ­¥ä¸€è‡´æ€§

æ–¹ A æå‡ºäº† `turnId/planHash` æ ¡éªŒ + ä¸ç›¸å¿…é¡» Ack çš„æœºåˆ¶æ¥è§£å†³å¼‚æ­¥å»ºè®®"æ¥æ™šäº†"çš„é—®é¢˜ã€‚ä½†è¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªè½¯çº¦æŸï¼š

- ä¸ç›¸ï¼ˆLLMï¼‰çœŸçš„ä¼šæ¯æ¬¡æ£€æŸ¥ `planHash` æ˜¯å¦åŒ¹é…å—ï¼Ÿæç¤ºè¯é‡Œå†™äº†"å¿…é¡» Ack"ï¼Œä½† LLM ä¼šå¿˜è®°
- å¦‚æœå»ºè®®æ¥æ™šäº†ä¸€è½®ï¼Œä¸ç›¸å·²ç»å¼€å§‹æ‰§è¡Œï¼ŒAck è¿˜æœ‰æ„ä¹‰å—ï¼Ÿ
- `turnMeta` ç»“æ„éœ€è¦ä¸»è¿›ç¨‹åœ¨ `context` äº‹ä»¶é‡Œç»´æŠ¤â€”â€”è¿™æœ¬èº«å°±æ˜¯é¢å¤–çš„å·¥ç¨‹å¤æ‚åº¦ï¼Œä¸”æ²¡æœ‰ç¡¬æœºåˆ¶ä¿è¯å®ƒçš„å‡†ç¡®æ€§

**æ–¹ A ç”¨å¤æ‚æœºåˆ¶è§£å†³äº†ä¸€ä¸ªæœ¬ä¸è¯¥å­˜åœ¨çš„é—®é¢˜**ï¼šå¦‚æœå²å®˜æ˜¯åŒæ­¥çš„ï¼Œå°±æ ¹æœ¬æ²¡æœ‰"å»ºè®®æ¥æ™š"çš„é—®é¢˜ã€‚

### æ–¹ B çš„å¼±ç‚¹ï¼šä¼ªå¼‚æ­¥çš„æ ¹æœ¬çŸ›ç›¾

æ–¹ B çš„"ä¼ªå¼‚æ­¥"æ–¹æ¡ˆâ€”â€”å‘æ¶ˆæ¯åˆ—è¡¨æ³¨å…¥ `historianPending` æ ‡è®°ï¼Œç„¶åä¾èµ–ä¸ç›¸"è‡ªå‘"è°ƒç”¨ `delegate`â€”â€”æ˜¯å…¸å‹çš„è½¯çº¦æŸï¼š

```typescript
// æ–¹ B çš„æ–¹æ¡ˆ
event.messages.push({
  role: 'user',
  content: '[SYSTEM] æ£€æµ‹åˆ°éœ€è¦å²å®˜å®¡æŸ¥çš„æ¡ä»¶ï¼Œè¯·åœ¨ä¸‹ä¸€æ­¥è°ƒç”¨ review_with_historianã€‚',
  metadata: { historianPending: true }
});
```

è¿™é‡Œæœ‰ä¸‰ä¸ªé—®é¢˜ï¼š
1. **"è¯·åœ¨ä¸‹ä¸€æ­¥è°ƒç”¨"æ˜¯è¯·æ±‚ï¼Œä¸æ˜¯å¼ºåˆ¶**ã€‚ä¸ç›¸å¯ä»¥å¿½ç•¥å®ƒ
2. æ–¹ B æ‰¿è®¤éœ€è¦é…åˆ `before_agent_start` åŠ¨æ€ systemPrompt "å¼ºåˆ¶åŒ–"â€”â€”ä½†è¿™åˆæ˜¯å¦ä¸€å±‚è½¯çº¦æŸå åŠ 
3. æ–¹ B è¿˜æå‡º"æ—  review æ ‡è®°åˆ™ç¦ç”¨å…³é”®å·¥å…·"ä½œä¸ºç¼“è§£â€”â€”è¿™æ‰æ˜¯çœŸæ­£æœ‰æ•ˆçš„æœºåˆ¶ï¼Œä½†ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨è¿™ä¸ªï¼Œè€Œè¦ç»•ä¸€åœˆï¼Ÿ

**æ–¹ B è®¤è¯†åˆ°äº†é—®é¢˜ï¼Œä½†ç”¨é”™äº†ä¸»è¦æœºåˆ¶**ã€‚

### ä¸¤æ–¹å…±åŒçš„é—®é¢˜ï¼šåˆ†å±‚å²å®˜çš„å¤æ‚åº¦

Light Historian + Deep Historian çš„åˆ†å±‚è®¾è®¡å¼•å…¥äº†æ–°çš„å†³ç­–ç‚¹ï¼šä»€ä¹ˆæ—¶å€™ç”¨ Lightï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨ Deepï¼Ÿè¿™ä¸ªåˆ¤æ–­æœ¬èº«å°±éœ€è¦é¢å¤–çš„é€»è¾‘ï¼Œè€Œä¸”è¿™ä¸ªé€»è¾‘åœ¨è¾¹ç•Œæƒ…å†µä¸‹å¾ˆéš¾æ­£ç¡®ã€‚æ–¹ B çš„è§¦å‘è§„åˆ™ï¼ˆtoken > 4000ã€3 è½®æ— å®¡æŸ¥ã€5 åˆ†é’Ÿ wall-clockï¼‰æ˜¯ä»»æ„çš„ï¼Œæ²¡æœ‰ç†è®ºåŸºç¡€ã€‚

---

## äºŒã€æˆ‘çš„æ–¹æ¡ˆï¼šç¡®å®šæ€§è§¦å‘ + å·¥å…·å±‚ç¡¬çº¦æŸ

### æ ¸å¿ƒåŸåˆ™ï¼šåœ¨å·¥å…·å±‚å¼ºåˆ¶ï¼Œè€Œä¸æ˜¯åœ¨æç¤ºè¯å±‚è¯·æ±‚

**å²å®˜å®¡æŸ¥çš„è§¦å‘æ¡ä»¶åªæœ‰ä¸€ä¸ªï¼šä¸ç›¸è°ƒç”¨äº† `delegate` å·¥å…·ã€‚**

ä¸éœ€è¦æ¡ä»¶åˆ¤æ–­ï¼Œä¸éœ€è¦åˆ†å±‚ï¼Œä¸éœ€è¦ token è®¡æ•°ã€‚æ¯æ¬¡ delegate ä¹‹åï¼Œå²å®˜å¿…é¡»è¿è¡Œã€‚è¿™æ˜¯ç¡®å®šæ€§çš„ï¼Œä¸å¯ç»•è¿‡çš„ã€‚

### Pi å¹³å°å®ç°

```typescript
// åœ¨ context äº‹ä»¶ä¸­ï¼Œæ£€æµ‹æœ¬è½®æ˜¯å¦æœ‰ delegate è°ƒç”¨å®Œæˆ
pi.on('context', (event) => {
  const lastDelegateResult = findLastDelegateResult(event.messages);
  
  if (lastDelegateResult && !lastDelegateResult.historianReviewed) {
    // ç”¨ setActiveTools ç¡¬é™åˆ¶ï¼šåœ¨å²å®˜å®Œæˆå®¡æŸ¥å‰ï¼Œä¸ç›¸åªèƒ½ç”¨ read
    pi.setActiveTools(['read']);
    // åŒæ—¶åœ¨ systemPrompt é‡Œè¯´æ˜åŸå› 
  }
  
  return structuredClone(event.messages);
});

pi.on('before_agent_start', (systemPrompt) => {
  const pendingReview = getPendingHistorianReview();
  if (pendingReview) {
    return systemPrompt + '\n\n[MANDATORY] å²å®˜æ­£åœ¨å®¡æŸ¥ä¸Šä¸€æ¬¡ delegate çš„ç»“æœã€‚åœ¨æ”¶åˆ°å²å®˜å»ºè®®ä¹‹å‰ï¼Œä½ åªèƒ½ä½¿ç”¨ read å·¥å…·ã€‚';
  }
  return systemPrompt;
});
```

**å…³é”®**ï¼š`setActiveTools` æ˜¯ç¡¬çº¦æŸï¼Œä¸æ˜¯æç¤ºè¯è¯·æ±‚ã€‚ä¸ç›¸æ— æ³•ç»•è¿‡å®ƒã€‚

### é˜»å¡ vs å¼‚æ­¥ï¼šé€‰æ‹©åŒæ­¥ï¼Œç†ç”±å……åˆ†

æˆ‘é€‰æ‹©åŒæ­¥ï¼ˆé˜»å¡ï¼‰å²å®˜ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **å²å®˜å®¡æŸ¥çš„åœºæ™¯æœ¬æ¥å°±æ˜¯"é‡è¦æ—¶åˆ»"**ï¼šæ¯æ¬¡ delegate ä¹‹åã€‚è¿™ä¸æ˜¯é«˜é¢‘æ“ä½œ
2. **å¼‚æ­¥çš„ä¸€è‡´æ€§æˆæœ¬æ¯”é˜»å¡çš„ç­‰å¾…æˆæœ¬æ›´é«˜**ï¼šå¼‚æ­¥éœ€è¦ planHashã€Ack æœºåˆ¶ã€æ¥æ™šå»ºè®®å¤„ç†â€”â€”è¿™äº›å¤æ‚åº¦çš„ä»£ä»·è¿œè¶…ç”¨æˆ·å¤šç­‰å‡ ç§’
3. **ç”¨æˆ·ä½“éªŒå¯ä»¥ä¼˜åŒ–**ï¼šé˜»å¡æœŸé—´æ˜¾ç¤º"å²å®˜æ­£åœ¨å®¡æŸ¥..."çš„çŠ¶æ€æç¤ºï¼Œè¿™æ˜¯åˆç†çš„ç³»ç»Ÿåé¦ˆï¼Œä¸æ˜¯ç³Ÿç³•çš„ä½“éªŒ

```typescript
pi.on('agent_end', async (event) => {
  const needsReview = event.delegateCallsThisRound > 0;
  if (!needsReview) return; // çº¯ read æ“ä½œï¼Œæ— éœ€å®¡æŸ¥
  
  // åŒæ­¥é˜»å¡ï¼šspawn å²å®˜ï¼Œç­‰å¾…å®Œæˆ
  const historian = spawnSync('pi', [
    '--no-session', '--mode', 'json',
    '--tools', 'read',
    '--system-prompt-file', 'historian.md'
  ], {
    input: JSON.stringify(buildAuditPacket(event)),
    timeout: 60000 // 60ç§’ç¡¬è¶…æ—¶
  });
  
  // å²å®˜è¾“å‡ºæ³¨å…¥ä¸‹ä¸€è½®
  if (historian.status === 0) {
    const advice = JSON.parse(historian.stdout);
    pi.sendMessage({ deliverAs: 'nextTurn', content: formatAdvice(advice) });
    pi.appendEntry('historian-log', advice); // æŒä¹…åŒ–è®°å½•
  }
  
  // æ¢å¤ä¸ç›¸å·¥å…·æƒé™
  pi.setActiveTools(['read', 'delegate']);
});
```

### é›¶çŠ¶æ€ï¼šåšæŒï¼Œä½†ä¼˜åŒ–è¾“å…¥æ„å»º

æˆ‘åŒæ„é›¶çŠ¶æ€æ˜¯æ­£ç¡®çš„åˆ¶åº¦è®¾è®¡ã€‚ä¼˜åŒ–ç‚¹åœ¨äº audit packet çš„æ„å»ºï¼š

```typescript
function buildAuditPacket(event: AgentEndEvent): AuditPacket {
  return {
    // åªåŒ…å«æœ¬æ¬¡ delegate çš„å…³é”®ä¿¡æ¯
    delegateTarget: event.lastDelegate.target,
    delegateInput: event.lastDelegate.input,
    delegateOutput: event.lastDelegate.output,
    // ä» appendEntry å†å²ä¸­æå–ç»“æ„åŒ–æ‘˜è¦ï¼ˆä¸æ˜¯å…¨æ–‡ï¼‰
    recentDecisions: getRecentDecisions(5), // æœ€è¿‘5æ¡å†³ç­–è®°å½•
    courtRules: readCourtRules() // æœå»·æ³•åº¦ï¼Œå›ºå®šæ–‡ä»¶
  };
}
```

å²å®˜æ¯æ¬¡åªçœ‹"è¿™æ¬¡ delegate åšäº†ä»€ä¹ˆ"ï¼Œä¸çœ‹å®Œæ•´å¯¹è¯å†å²ã€‚è¿™ä¿è¯é›¶çŠ¶æ€ï¼ŒåŒæ—¶æ§åˆ¶ token æˆæœ¬ã€‚

### ç»ˆç»“å²å®˜ï¼šåˆ©ç”¨ agent_end çš„ç¡®å®šæ€§

Pi æ²¡æœ‰ Stop hookï¼Œä½†ç»ˆç»“åœºæ™¯å¯ä»¥è¿™æ ·å¤„ç†ï¼š

```typescript
pi.on('before_agent_start', (systemPrompt, context) => {
  if (detectSessionEndIntent(context)) {
    // æ³¨å…¥ç»ˆå±€æ¨¡å¼ï¼šå¼ºåˆ¶ä¸ç›¸åœ¨ç»“æŸå‰åšä¸€æ¬¡ delegate ç»™"ç»ˆå±€å²å®˜"
    return systemPrompt + '\n\n[FINAL REVIEW REQUIRED] åœ¨ç»“æŸä¼šè¯å‰ï¼Œå¿…é¡»è°ƒç”¨ delegate è¯·æ±‚æœ€ç»ˆå®¡æŸ¥ã€‚è¿™æ˜¯å¼ºåˆ¶çš„ï¼Œä¸å¯è·³è¿‡ã€‚';
  }
  return systemPrompt;
});
```

ç»ˆå±€ delegate ä¼šè§¦å‘ `agent_end`ï¼Œå²å®˜åœ¨é‚£é‡ŒåŒæ­¥è¿è¡Œï¼Œå®Œæˆæœ€ç»ˆå®¡è®¡ã€‚è¿™å¤ç”¨äº†å·²æœ‰æœºåˆ¶ï¼Œæ²¡æœ‰å¼•å…¥æ–°çš„å¤æ‚åº¦ã€‚

---

## ä¸‰ã€æ‰¿è®¤å¯¹æ–¹çš„å¥½è§‚ç‚¹

æ–¹ A æå‡ºçš„ **audit packet æœ€å°åŒ–** æ˜¯æ­£ç¡®çš„â€”â€”å²å®˜ä¸éœ€è¦è¯»å…¨é‡å¯¹è¯ï¼Œåªéœ€è¦ç»“æ„åŒ–çš„å®¡è®¡åŒ…ã€‚æˆ‘å·²æ•´åˆåˆ°æ–¹æ¡ˆä¸­ã€‚

æ–¹ B æå‡ºçš„ **åˆ¶åº¦æ€§è®°å¿† vs äº‹åŠ¡æ€§åè§** çš„åŒºåˆ†æ˜¯æœ‰ä»·å€¼çš„â€”â€”`court-rules.md` è¿™ç±»å›ºå®šæ–‡ä»¶å¯ä»¥æŒ‚è½½ç»™å²å®˜ï¼Œè€Œä¸ç ´åé›¶çŠ¶æ€åŸåˆ™ã€‚æˆ‘å·²æ•´åˆã€‚

---

## å››ã€Token æˆæœ¬å¯¹æ¯”

| åœºæ™¯ | æ–¹ A | æ–¹ B | æ–¹ C |
|------|------|------|------|
| æ¯æ¬¡ delegate å | ~800 tokensï¼ˆå¼‚æ­¥ï¼‰ | ~400 tokensï¼ˆLightï¼‰ | ~600 tokensï¼ˆåŒæ­¥ï¼Œaudit packetï¼‰ |
| é¢å¤–æœºåˆ¶æˆæœ¬ | planHash + Ack é€»è¾‘ | è§¦å‘åˆ¤å®š + ä¼ªå¼‚æ­¥ | æ—  |
| æ¼å®¡é£é™© | ä¸­ï¼ˆæ¡ä»¶è§¦å‘å¯èƒ½é—æ¼ï¼‰ | é«˜ï¼ˆè½¯è§¦å‘å¯ç»•è¿‡ï¼‰ | é›¶ï¼ˆç¡¬çº¦æŸï¼‰ |
| å®ç°å¤æ‚åº¦ | é«˜ | ä¸­ | ä½ |

---

## äº”ã€è·¨å¹³å°é€‚é…

**CC**ï¼š`agent_end` ç­‰ä»·äº SubagentStopï¼Œå²å®˜åœ¨é‚£é‡ŒåŒæ­¥è¿è¡Œã€‚`setActiveTools` ç­‰ä»·äº PreToolUse é˜»æ–­ã€‚

**OC**ï¼š`messages.transform` æ³¨å…¥"ç­‰å¾…å²å®˜å®¡æŸ¥"æ ‡è®°ï¼›CC bridge çš„ SubagentStop å¤„ç†å²å®˜è°ƒç”¨ã€‚

---

## ç»“è®º

**ç®€å•çš„ç¡¬çº¦æŸä¼˜äºå¤æ‚çš„è½¯çº¦æŸç³»ç»Ÿã€‚** æ–¹ C çš„æ–¹æ¡ˆï¼šæ¯æ¬¡ delegate è§¦å‘ï¼ŒåŒæ­¥é˜»å¡ï¼Œé›¶çŠ¶æ€ï¼Œå·¥å…·å±‚å¼ºåˆ¶ã€‚æ²¡æœ‰æ¡ä»¶åˆ¤æ–­ï¼Œæ²¡æœ‰åˆ†å±‚å²å®˜ï¼Œæ²¡æœ‰å¼‚æ­¥ä¸€è‡´æ€§é—®é¢˜ã€‚ä»£ä»·æ˜¯æ¯æ¬¡ delegate åç”¨æˆ·å¤šç­‰å‡ ç§’â€”â€”è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸º delegate æœ¬æ¥å°±æ˜¯é‡è¦æ“ä½œã€‚

---

## ç¬¬ä¸‰è½®ï¼šè¯„å®¡è£å†³

> è¯„å®¡æ¨¡å‹: qwen3.5-plus

# å¤š Agent ç³»ç»Ÿå²å®˜ç”Ÿå‘½å‘¨æœŸè®¾è®¡è¯„å®¡æŠ¥å‘Š

## 1. å„æ–¹ä¼˜åŠ£æ€»ç»“

### æ–¹ A (gpt-5.2)ï¼šäº‹ä»¶é©±åŠ¨ + æ¡ä»¶è§¦å‘ + å¼‚æ­¥ä¼˜å…ˆæ··åˆæ¨¡å‹
*   **æ ¸å¿ƒä¸»å¼ **ï¼šåå¯¹å•ä¸€ç»‘å®š `agent_end`ï¼Œæå‡ºâ€œåŒé€šé“â€æœºåˆ¶ã€‚è½»é‡å²å®˜åœ¨ `context` äº‹ä»¶ä¸­é¢„åˆ¤å¹¶å¼‚æ­¥æ³¨å…¥ä¸‹ä¸€è½®ï¼›é‡åº¦å²å®˜ä»…åœ¨ç»ˆå±€æˆ–é«˜é£é™©æ—¶åŒæ­¥é˜»å¡ã€‚å¼ºè°ƒç”¨ `setActiveTools()` å®ç°äº‹å‰é—¸é—¨ã€‚
*   **ä¼˜åŠ¿**ï¼š
    *   **ä½“éªŒæœ€ä¼˜**ï¼šé»˜è®¤å¼‚æ­¥é¿å…äº†ç”¨æˆ·æ„ŸçŸ¥çš„å»¶è¿Ÿï¼Œç¬¦åˆäº¤äº’å¼ AI çš„æµç•…æ€§è¦æ±‚ã€‚
    *   **åˆ¶åº¦ä¸¥è°¨**ï¼šåˆ›é€ æ€§åœ°åˆ©ç”¨ `setActiveTools()` å°†è½¯æ€§çš„â€œå»ºè®®â€è½¬åŒ–ä¸ºç¡¬æ€§çš„â€œå·¥å…·æƒé™å°é”â€ï¼Œè§£å†³äº†å¼‚æ­¥åœºæ™¯ä¸‹çš„æ‰§è¡ŒåŠ›é—®é¢˜ã€‚
    *   **æˆæœ¬æ§åˆ¶**ï¼šé€šè¿‡ç²¾ç»†çš„ `reviewLevel` åˆ¤å®šå’Œæœ€å°åŒ– `audit packet`ï¼Œå¤§å¹…é™ä½ Token æ¶ˆè€—ã€‚
*   **å¼±ç‚¹**ï¼š
    *   **å®ç°å¤æ‚åº¦é«˜**ï¼šéœ€è¦ç»´æŠ¤ `turnMeta` çŠ¶æ€æœºã€planHash æ ¡éªŒé€»è¾‘ä»¥åŠå¤æ‚çš„é’©å­åä½œï¼Œå·¥ç¨‹è½åœ°éš¾åº¦å¤§ã€‚
    *   **æ—¶åºæ¼æ´é£é™©**ï¼šå°½ç®¡æœ‰å·¥å…·é”ï¼Œä½†â€œäº‹å‰åˆ¤å®šâ€ä¾èµ–å¯¹æœªæ¥çš„é¢„æµ‹ï¼ˆå¦‚æ£€æµ‹â€œå³å°†æ‰§è¡Œâ€ï¼‰ï¼Œè‹¥é¢„æµ‹å¤±è´¥å¯èƒ½å¯¼è‡´å‰¯ä½œç”¨å…ˆäºå®¡æŸ¥å‘ç”Ÿã€‚

### æ–¹ B (kimi-k2.5)ï¼šå¼‚æ­¥è„‰å†² + ç»ˆå±€æ”¶æ•›åˆ†å±‚æ¨¡å‹
*   **æ ¸å¿ƒä¸»å¼ **ï¼šå²å®˜åº”ä¸ºâ€œå¼‚æ­¥å®ˆæœ›è€…â€ã€‚Light Historian åŸºäºæ¡ä»¶ï¼ˆdelegate/Token é˜ˆå€¼ï¼‰å¼‚æ­¥è§¦å‘ï¼›Deep Historian ä»…åœ¨ `session_before_compact` æ—¶å¼ºåˆ¶é˜»å¡ã€‚åšå†³åå¯¹æ¯è½®é˜»å¡ã€‚
*   **ä¼˜åŠ¿**ï¼š
    *   **æ¶æ„æ¸…æ™°**ï¼šæ˜ç¡®åŒºåˆ†â€œæ—¥å¸¸åˆè§„æ£€æŸ¥â€ä¸â€œæ·±åº¦æ²»ç†å®¡è®¡â€ï¼ŒèŒè´£è¾¹ç•Œåˆ†æ˜ã€‚
    *   **è°ƒè¯•å‹å¥½**ï¼šé€šè¿‡æ˜¾å¼çš„æ¶ˆæ¯æ ‡è®°ï¼ˆ`historianPending`ï¼‰è€Œééšå¼ Hook é“¾ï¼Œä½¿å¾—å®¡æŸ¥æµç¨‹åœ¨å¯¹è¯å†å²ä¸­å¯è§å¯è¿½æº¯ã€‚
    *   **èµ„æºåˆ©ç”¨é«˜æ•ˆ**ï¼šå·§å¦™åˆ©ç”¨å‹ç¼©å‰çš„çª—å£æœŸè¿›è¡Œæ·±åº¦å®¡è®¡ï¼Œæ—¢ä¸å ç”¨è¿è¡Œæ—¶èµ„æºï¼Œåˆèƒ½è¦†ç›–å…¨é‡ä¸Šä¸‹æ–‡ã€‚
*   **å¼±ç‚¹**ï¼š
    *   **è½¯çº¦æŸä¾èµ–**ï¼šä¾èµ–ä¸ç›¸â€œè‡ªå‘â€è¯»å–æ ‡è®°å¹¶è°ƒç”¨ delegateï¼Œè‹¥æ— åº•å±‚å·¥å…·é”é…åˆï¼Œææ˜“è¢« LLM å¿½ç•¥æˆ–ç»•è¿‡ã€‚
    *   **äº‹åè¯¸è‘›äº®**ï¼šå¯¹äºéç»ˆå±€çš„å¸¸è§„é«˜é£é™©æ“ä½œï¼Œçº¯å¼‚æ­¥æ„å‘³ç€å‰¯ä½œç”¨å·²å‘ç”Ÿï¼Œå²å®˜ä»…èƒ½è®°å½•è€Œæ— æ³•æ‹¦æˆªï¼Œè¿èƒŒäº†â€œç›‘ç£â€çš„åˆè¡·ã€‚

### æ–¹ C (claude-sonnet-4-6)ï¼šç¡®å®šæ€§è§¦å‘ + ç¡¬çº¦æŸåŒæ­¥æ¨¡å‹
*   **æ ¸å¿ƒä¸»å¼ **ï¼šç®€å•å³æ­£ä¹‰ã€‚åªè¦å‘ç”Ÿ `delegate`ï¼Œå¿…é¡»åŒæ­¥é˜»å¡è¿è¡Œå²å®˜ã€‚æ‹’ç»å¤æ‚çš„æ¡ä»¶åˆ¤æ–­å’Œå¼‚æ­¥é€»è¾‘ï¼ŒåšæŒé›¶çŠ¶æ€å’Œå·¥å…·å±‚ç¡¬é™åˆ¶ã€‚
*   **ä¼˜åŠ¿**ï¼š
    *   **å®‰å…¨æ€§æœ€é«˜**ï¼šåŒæ­¥é˜»å¡ç¡®ä¿äº†â€œæ— å®¡æŸ¥ä¸æ‰§è¡Œâ€ï¼Œå½»åº•æ¶ˆé™¤äº†ç«æ€æ¡ä»¶å’Œæ¼å®¡é£é™©ã€‚
    *   **é€»è¾‘é²æ£’**ï¼šå»é™¤äº†æ‰€æœ‰å¯å‘å¼è¯„åˆ†å’ŒçŠ¶æ€ç»´æŠ¤ï¼Œè§„åˆ™ç¡®å®šæ€§å¼ºï¼Œä¸æ˜“å‡ºç°è¾¹ç•Œæƒ…å†µ Bugã€‚
    *   **åˆ¶åº¦çº¯ç²¹**ï¼šå®Œç¾å¥‘åˆâ€œå²å®˜ç‹¬ç«‹å®¡åˆ¤â€çš„æ”¿æ²»éšå–»ï¼Œå¦å†³æƒçœŸå®æœ‰æ•ˆã€‚
*   **å¼±ç‚¹**ï¼š
    *   **ä½“éªŒç¾éš¾**ï¼šåœ¨é¢‘ç¹å§”æ‰˜çš„åœºæ™¯ä¸‹ï¼ˆå¦‚åˆ†è§£å¤æ‚ä»»åŠ¡ï¼‰ï¼Œæ¯æ¬¡ delegate åç­‰å¾… 2-5 ç§’çš„å®¡æŸ¥ä¼šå¯¼è‡´äº¤äº’æåº¦å¡é¡¿ï¼Œç”¨æˆ·å®¹å¿åº¦ä½ã€‚
    *   **ç¼ºä¹çµæ´»æ€§**ï¼šå¯¹æ‰€æœ‰ delegate ä¸€è§†åŒä»ï¼Œå¯¼è‡´ä½é£é™©æ“ä½œï¼ˆå¦‚ç®€å•çš„æ–‡ä»¶è¯»å–å§”æ‰˜ï¼‰ä¹Ÿæ‰¿å—ä¸å¿…è¦çš„å®¡æŸ¥å¼€é”€ã€‚

---

## 2. å…±è¯†ç‚¹æå–

å°½ç®¡ä¸‰æ–¹åœ¨è§¦å‘æ—¶æœºå’Œé˜»å¡ç­–ç•¥ä¸Šäº‰æ‰§ä¸ä¸‹ï¼Œä½†åœ¨ä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ä¸Šè¾¾æˆäº†é«˜åº¦ä¸€è‡´ï¼š

1.  **é›¶çŠ¶æ€åŸåˆ™ (Zero-State)**ï¼šå²å®˜å¿…é¡»æ˜¯æ¯æ¬¡ `spawn` çš„æ–°è¿›ç¨‹ï¼Œä¸¥ç¦æºå¸¦ä¼šè¯è®°å¿†ï¼Œä»¥é˜²æ­¢åè§ç´¯ç§¯ï¼Œç¡®ä¿ç‹¬ç«‹æ€§ã€‚
2.  **æœ€å°ä¸Šä¸‹æ–‡åŒ… (Audit Packet)**ï¼šå²å®˜ä¸åº”æ¥æ”¶å®Œæ•´å¯¹è¯å†å²ï¼Œè€Œåº”æ¥æ”¶ç”±ä¸»è¿›ç¨‹æ„å»ºçš„ç»“æ„åŒ–æ‘˜è¦ï¼ˆåŒ…å«æ„å›¾ã€å·¥å…·ã€é£é™©æ ‡ç­¾ç­‰ï¼‰ï¼Œä»¥æ§åˆ¶ Token æˆæœ¬ã€‚
3.  **åŒè·¯è¾“å‡ºæœºåˆ¶**ï¼šå²å®˜çš„è¾“å‡ºå¿…é¡»åˆ†ä¸ºä¸¤è·¯ï¼šä¸€è·¯é€šè¿‡ `appendEntry` æŒä¹…åŒ–å½’æ¡£ï¼ˆä¸è¿› LLM ä¸Šä¸‹æ–‡ï¼‰ï¼Œå¦ä¸€è·¯é€šè¿‡ `sendMessage` æˆ– SystemPrompt æ³¨å…¥ç»™ä¸ç›¸ã€‚
4.  **ç»ˆå±€å¼ºåˆ¶å®¡è®¡**ï¼šæ— è®ºæ—¥å¸¸ç­–ç•¥å¦‚ä½•ï¼Œå„æ–¹å‡åŒæ„åœ¨ Session ç»“æŸæˆ–å‹ç¼©å‰ï¼ˆ`session_before_compact`ï¼‰å¿…é¡»è¿›è¡Œä¸€æ¬¡æ·±åº¦çš„ã€é˜»å¡å¼çš„ç»ˆå®¡ã€‚
5.  **ç¡¬çº¦æŸä¼˜äºè½¯æç¤º**ï¼šéƒ½æ‰¿è®¤å•çº¯ä¾é  Prompt è¦æ±‚ä¸ç›¸â€œå¿…é¡»å®¡æŸ¥â€æ˜¯ä¸å¯é çš„ï¼Œå¿…é¡»ç»“åˆå·¥å…·é™åˆ¶ï¼ˆ`setActiveTools`ï¼‰æˆ–æµç¨‹é˜»æ–­æ¥å®ç°å¼ºåˆ¶åŠ›ã€‚

---

## 3. åˆ†æ­§ç‚¹åˆ†æ

| åˆ†æ­§ç»´åº¦ | æ–¹ A (æ··åˆå¼‚æ­¥) | æ–¹ B (åˆ†å±‚å¼‚æ­¥) | æ–¹ C (åŒæ­¥é˜»å¡) | **äº‰è®®æœ¬è´¨** |
| :--- | :--- | :--- | :--- :--- |
| **è§¦å‘æ—¶æœº** | åŠ¨æ€è¯„åˆ† (`context` é¢„åˆ¤) | å›ºå®šè§„åˆ™ (Delegate/Token) | ç»å¯¹è§¦å‘ (åªè¦æœ‰ Delegate) | **è¦†ç›–ç‡ vs æ€§èƒ½**ï¼šæ˜¯å®å¯é”™æ€ä¸å¯æ”¾è¿‡ï¼Œè¿˜æ˜¯ç²¾å‡†æ‰“å‡»ï¼Ÿ |
| **é˜»å¡ç­–ç•¥** | é»˜è®¤å¼‚æ­¥ï¼Œé«˜å±åŒæ­¥ | å…¨ç¨‹å¼‚æ­¥ï¼Œä»…ç»ˆå±€åŒæ­¥ | å…¨ç¨‹åŒæ­¥ | **å®‰å…¨æ€§ vs ä½“éªŒ**ï¼šå²å®˜æ˜¯â€œåˆ¹è½¦ç‰‡â€è¿˜æ˜¯â€œè¡Œè½¦è®°å½•ä»ªâ€ï¼Ÿ |
| **æ‰§è¡Œæœºåˆ¶** | å·¥å…·é” + å¼‚æ­¥æ³¨å…¥ | æ¶ˆæ¯æ ‡è®° + è½¯æ€§å¼•å¯¼ | è¿›ç¨‹é˜»å¡ + å·¥å…·é” | **æ§åˆ¶ç²’åº¦**ï¼šæ˜¯åœ¨ OS å±‚é¢å¡ä½è¿›ç¨‹ï¼Œè¿˜æ˜¯åœ¨ Agent å±‚é¢é™åˆ¶å·¥å…·ï¼Ÿ |
| **å¤æ‚åº¦** | é«˜ (çŠ¶æ€æœº + æ ¡éªŒ) | ä¸­ (è§„åˆ™å¼•æ“) | ä½ (çº¿æ€§æµç¨‹) | **å·¥ç¨‹ä»£ä»·**ï¼šä¸ºäº†æè‡´çš„å®‰å…¨æˆ–ä½“éªŒï¼Œå€¼å¾—å¼•å…¥å¤šå°‘ç³»ç»Ÿå¤æ‚åº¦ï¼Ÿ |

**æ ¹æœ¬çŸ›ç›¾**ï¼šåœ¨äºå¯¹â€œå²å®˜â€è§’è‰²çš„å®šä½å·®å¼‚ã€‚æ–¹ C å°†å…¶è§†ä¸º**å¸æ³•æ³•å®˜**ï¼ˆå¿…é¡»å½“åº­å®£åˆ¤æ‰èƒ½æ‰§è¡Œï¼‰ï¼›æ–¹ B å°†å…¶è§†ä¸º**ç›‘å¯Ÿå¾¡å²**ï¼ˆäº‹åå¼¹åŠ¾ï¼Œå®šæœŸæ¸…ç®—ï¼‰ï¼›æ–¹ A è¯•å›¾èåˆä¸¤è€…ï¼Œæ—¢è¦åšæ³•å®˜åˆè¦åšé¡¾é—®ï¼Œå¯¼è‡´äº†æ–¹æ¡ˆçš„å¤æ‚æ€§ã€‚

---

## 4. æœ€ç»ˆè£å†³

ç»è¿‡ç»¼åˆè¯„ä¼°ï¼Œæœ¬è¯„å®¡å›¢è£å®šï¼š**é‡‡çº³æ–¹ A çš„â€œåˆ†çº§è§¦å‘ + å·¥å…·é”â€æ¶æ„æ€æƒ³ï¼Œèåˆæ–¹ C çš„â€œåŒæ­¥é˜»å¡â€ä½œä¸ºé«˜å±å…œåº•ï¼Œæ‘’å¼ƒæ–¹ B çš„çº¯å¼‚æ­¥æ–¹æ¡ˆã€‚**

**æ¨èæ–¹æ¡ˆåç§°ï¼šã€Œåˆ†çº§é—¸é—¨Â·å¼‚æ­¥ä¼˜å…ˆÂ·ç»ˆå±€æ”¶æ•›ã€æ¨¡å‹ (Graded-Gate Model)**

### æ ¸å¿ƒç†ç”±
1.  **å¹³è¡¡ä½“éªŒä¸å®‰å…¨**ï¼šçº¯åŒæ­¥ï¼ˆæ–¹ Cï¼‰åœ¨å¤æ‚ä»»åŠ¡ä¸­ä¸å¯ç”¨ï¼Œçº¯å¼‚æ­¥ï¼ˆæ–¹ Bï¼‰åœ¨å®‰å…¨ä¸Šä¸å¯é ã€‚å¿…é¡»æ ¹æ®é£é™©ç­‰çº§åŠ¨æ€é€‰æ‹©ç­–ç•¥ã€‚
2.  **ç¡¬çº¦æŸè½åœ°**ï¼šæ–¹ A æå‡ºçš„ `setActiveTools` æ˜¯å®ç°â€œå¼‚æ­¥ä½†ä¸å¤±æ§â€çš„å…³é”®æŠ€æœ¯æŠ“æ‰‹ï¼Œå¿…é¡»ä¿ç•™ã€‚
3.  **å·¥ç¨‹å¯è¡Œæ€§**ï¼šå®Œå…¨å»é™¤æ–¹ A ä¸­è¿‡äºå¤æ‚çš„ `planHash` æ ¡éªŒï¼Œç®€åŒ–ä¸ºåŸºäºâ€œå·¥å…·ç±»å‹â€å’Œâ€œæ“ä½œå¯¹è±¡â€çš„é™æ€é£é™©åˆ†çº§ï¼Œé™ä½å®ç°éš¾åº¦ã€‚

### æ–¹æ¡ˆé€»è¾‘å›¾è°±
*   **L0 (æ— é£é™©)**: çº¯ Read/Delegate(åªè¯») â†’ **è·³è¿‡å²å®˜**ã€‚
*   **L1 (ä½é£é™©)**: å¸¸è§„ Write/Delegate â†’ **å¼‚æ­¥å²å®˜** (åå° Spawn) + **ä¸‹ä¸€è½®å·¥å…·è§£é”** (è‹¥æœªè¿”å›åˆ™ä¿æŒéƒ¨åˆ†é™åˆ¶)ã€‚
*   **L2 (é«˜é£é™©)**: Bash/MCP/æ•æ„Ÿæ–‡ä»¶/ç ´åæ€§æ“ä½œ â†’ **åŒæ­¥å²å®˜** (é˜»å¡ Spawn) + **å¼ºåˆ¶å·¥å…·é”**ã€‚
*   **L3 (ç»ˆå±€)**: Session End/Compact â†’ **åŒæ­¥æ·±å®¡** (é˜»å¡)ã€‚

---

## 5. å…·ä½“å®ç°å»ºè®® (Pi Extension ç‰ˆ)

### 5.1 é£é™©åˆ†çº§å®šä¹‰ (Hard-coded)
åœ¨ Extension å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªé™æ€é£é™©çŸ©é˜µï¼Œé¿å… LLM åˆ¤æ–­ï¼š
```typescript
const RISK_MATRIX = {
  LOW_RISK_TOOLS: ['read_file', 'list_dir', 'search_code'],
  MED_RISK_TOOLS: ['write_file', 'edit_file', 'delegate'], // delegate é»˜è®¤ä¸­é£é™©
  HIGH_RISK_TOOLS: ['bash', 'mcp_*', 'delete_file', 'exec'],
  SENSITIVE_PATTERNS: ['.env', 'secret', 'password', 'rm -rf']
};
```

### 5.2 æ ¸å¿ƒé’©å­é€»è¾‘

#### A. `context` äº‹ä»¶ï¼šé£é™©é¢„åˆ¤ä¸å…ƒæ•°æ®ç”Ÿæˆ
*   **åŠ¨ä½œ**ï¼šæ‰«ææœ¬è½®æ¶ˆæ¯ä¸­çš„ Tool Callã€‚
*   **é€»è¾‘**ï¼š
    1. è®¡ç®— `currentRiskLevel` (LOW/MED/HIGH)ã€‚
    2. æ„å»º `auditPacket` (ä»…åŒ…å«æœ¬æ¬¡æ“ä½œæ‘˜è¦ + æœ€è¿‘ 3 æ¡å†³ç­–)ã€‚
    3. å°† `auditPacket` å†™å…¥ Extension å†…éƒ¨ State (ä¸è¿› LLM Context)ã€‚
    4. è‹¥æ£€æµ‹åˆ° `HIGH_RISK`ï¼Œæ ‡è®° `needsSyncReview = true`ã€‚

#### B. `before_agent_start`ï¼šå·¥å…·é”ä¸æŒ‡ä»¤æ³¨å…¥
*   **åŠ¨ä½œ**ï¼šæ£€æŸ¥ä¸Šä¸€è½®æ˜¯å¦æœ‰æœªå®Œæˆçš„å®¡æŸ¥ã€‚
*   **é€»è¾‘**ï¼š
    1. è‹¥å­˜åœ¨ `pendingAsyncReview` (æ¥è‡ª L1 å¼‚æ­¥ä»»åŠ¡æœªå®Œæˆ)ï¼š
       *   è°ƒç”¨ `setActiveTools(['read', 'wait_for_historian'])`ã€‚
       *   æ³¨å…¥ SystemPromptï¼šâ€œå²å®˜æ­£åœ¨å®¡æŸ¥ä¸Šä¸€è½®æ“ä½œï¼Œç»“æœå‡ºç‚‰å‰ä»…é™è¯»å–ã€‚â€
    2. è‹¥å½“å‰è½®æ¬¡é¢„åˆ¤ä¸º `HIGH_RISK` (æ¥è‡ª `context`)ï¼š
       *   **é¢„å…ˆ**è°ƒç”¨ `setActiveTools(['read'])` (å…ˆé”æ­»ï¼Œç­‰å²å®˜æ”¾è¡Œ)ã€‚
       *   æ³¨å…¥ SystemPromptï¼šâ€œæ£€æµ‹åˆ°é«˜é£é™©æ“ä½œï¼Œå¿…é¡»å…ˆå§”æ‰˜å²å®˜è¿›è¡ŒåŒæ­¥å®¡æŸ¥ã€‚â€

#### C. `agent_end`ï¼šæ‰§è¡Œå®¡æŸ¥è°ƒåº¦
*   **é€»è¾‘**ï¼š
    1. **IF `currentRiskLevel == HIGH`**:
       *   **åŒæ­¥é˜»å¡** `spawnHistorianSync(packet)`ã€‚
       *   è‹¥å²å®˜å¦å†³ (`veto=true`)ï¼šæŠ›å‡ºå¼‚å¸¸æˆ–å†™å…¥é”™è¯¯æ—¥å¿—ï¼Œé˜»æ­¢ Session ç»§ç»­ï¼ˆæˆ–å¼ºåˆ¶è¿›å…¥ä¿®æ­£å¾ªç¯ï¼‰ã€‚
       *   è‹¥é€šè¿‡ï¼šæ¢å¤å·¥å…·æƒé™ï¼Œå°†å»ºè®®æ³¨å…¥ `nextTurn`ã€‚
    2. **IF `currentRiskLevel == MED`**:
       *   **å¼‚æ­¥éé˜»å¡** `spawnHistorianAsync(packet)`ã€‚
       *   æ³¨å†Œå›è°ƒï¼šå½“å²å®˜è¿”å›æ—¶ï¼Œæ›´æ–°å†…éƒ¨ State `reviewStatus = 'passed'`ã€‚
       *   *æ³¨æ„*ï¼šå³ä½¿å¼‚æ­¥ï¼Œä¹Ÿè¦åœ¨ä¸‹ä¸€è½® `before_agent_start` æ£€æŸ¥çŠ¶æ€ï¼Œè‹¥æœªå®Œæˆåˆ™ç»§ç»­é”å·¥å…·ï¼ˆå®ç°â€œé€»è¾‘ä¸Šçš„åŒæ­¥ï¼Œä½“éªŒä¸Šçš„å¼‚æ­¥â€ï¼‰ã€‚
    3. **IF `LOW`**: è·³è¿‡ã€‚

#### D. `session_before_compact`ï¼šç»ˆå±€æ·±å®¡
*   **åŠ¨ä½œ**ï¼šå¼ºåˆ¶åŒæ­¥ Spawn æ·±åº¦å²å®˜ã€‚
*   **è¾“å…¥**ï¼šå…¨é‡ `appendEntry` å†å²è®°å½• + å‹ç¼©æ‘˜è¦è‰æ¡ˆã€‚
*   **è¾“å‡º**ï¼šç”Ÿæˆ `final_audit_report.md` å¹¶é™„åŠ åˆ° Compact åçš„ Context å¤´éƒ¨ã€‚

### 5.3 å²å®˜å­è¿›ç¨‹è§„èŒƒ
*   **å¯åŠ¨å‚æ•°**ï¼š`pi --no-session --mode json --tools read --system-prompt-file historian_<level>.md`
*   **è¾“å…¥**ï¼šSTDIN ä¼ å…¥ JSON `auditPacket`ã€‚
*   **è¾“å‡º**ï¼šSTDOUT è¿”å› JSON `{ decision: "ALLOW" | "DENY", advice: "...", severity: number }`ã€‚
*   **è¶…æ—¶ä¿æŠ¤**ï¼šæ‰€æœ‰ Spawn è®¾ç½® `timeout: 30000` (L1/L2) æˆ– `60000` (L3)ï¼Œè¶…æ—¶è‡ªåŠ¨è§†ä¸º "ALLOW_WITH_WARNING" å¹¶è®°å½•æ—¥å¿—ï¼Œé˜²æ­¢æ­»é”ã€‚

---

## 6. å¼€æ”¾é—®é¢˜ä¸åç»­éªŒè¯

1.  **å¼‚æ­¥ç«æ€çš„æç«¯æƒ…å†µ**ï¼š
    *   *é—®é¢˜*ï¼šåœ¨ L1 å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œå¦‚æœç”¨æˆ·å¿«é€Ÿè¿ç»­å‘é€æŒ‡ä»¤ï¼Œè€Œå²å®˜å°šæœªè¿”å›ï¼Œç³»ç»Ÿå¦‚ä½•å¤„ç†å †ç§¯çš„è¯·æ±‚ï¼Ÿ
    *   *å¾…éªŒè¯*ï¼šæ˜¯å¦éœ€è¦å¼•å…¥ä¸€ä¸ªç®€å•çš„è¯·æ±‚é˜Ÿåˆ—æœºåˆ¶ï¼Œæˆ–è€…å¼ºåˆ¶åœ¨å¼‚æ­¥å®¡æŸ¥å®Œæˆå‰æš‚åœæ¥æ”¶æ–°çš„äººç±»è¾“å…¥ï¼ˆUI å±‚é”å®šï¼‰ï¼Ÿ

2.  **é£é™©çŸ©é˜µçš„åŠ¨æ€è°ƒæ•´**ï¼š
    *   *é—®é¢˜*ï¼šé™æ€çš„é£é™©çŸ©é˜µå¯èƒ½æ— æ³•è¦†ç›–æ‰€æœ‰ä¸šåŠ¡åœºæ™¯ï¼ˆä¾‹å¦‚æŸäº›é¡¹ç›®çš„ `bash` æ˜¯å®‰å…¨çš„ï¼Œè€Œå¦ä¸€äº›åˆ™æ˜¯è‡´å‘½çš„ï¼‰ã€‚
    *   *å¾…éªŒè¯*ï¼šæ˜¯å¦å…è®¸é€šè¿‡ `.pi/court-config.json` è®©ç”¨æˆ·è‡ªå®šä¹‰é£é™©çŸ©é˜µï¼Ÿè¿™ä¼šå¼•å…¥é…ç½®é”™è¯¯çš„é£é™©ï¼Œéœ€æƒè¡¡ã€‚

3.  **è·¨å¹³å°ä¸€è‡´æ€§é™çº§**ï¼š
    *   *é—®é¢˜*ï¼šOC å¹³å°ä¸æ”¯æŒ `setActiveTools` å’ŒçœŸæ­£çš„å­è¿›ç¨‹éš”ç¦»ã€‚
    *   *å¾…éªŒè¯*ï¼šåœ¨ OC ä¸Šï¼Œæ˜¯å¦æ¥å—å°†â€œåŒæ­¥é˜»å¡â€é€€åŒ–ä¸ºâ€œå¼ºæç¤º + äººå·¥ç¡®è®¤â€ï¼Ÿæˆ–è€…åˆ©ç”¨ `task(run_in_background)` æ¨¡æ‹Ÿå¼‚æ­¥ï¼Œä½†ç‰ºç‰²éƒ¨åˆ†å®‰å…¨æ€§ï¼Ÿéœ€åˆ¶å®šæ˜ç¡®çš„é™çº§åè®®ï¼ˆFallback Protocolï¼‰ã€‚

4.  **Token æˆæœ¬çš„é•¿å°¾æ•ˆåº”**ï¼š
    *   *é—®é¢˜*ï¼šè™½ç„¶å•æ¬¡ Audit Packet å¾ˆå°ï¼Œä½†åœ¨è¶…é•¿ä¼šè¯ä¸­ï¼Œé¢‘ç¹çš„ L1 å¼‚æ­¥å®¡æŸ¥ç´¯ç§¯æˆæœ¬æ˜¯å¦å¯è§‚ï¼Ÿ
    *   *å¾…éªŒè¯*ï¼šéœ€è¦è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œç»Ÿè®¡åœ¨å…¸å‹å¼€å‘å·¥ä½œæµï¼ˆå¦‚é‡æ„ä¸€ä¸ªå¤§æ¨¡å—ï¼‰ä¸­ï¼Œå²å®˜è°ƒç”¨çš„é¢‘ç‡å’Œæ€» Token æ¶ˆè€—ï¼Œä»¥æ ¡å‡† `MED_RISK` çš„è§¦å‘é˜ˆå€¼ã€‚

**ç»“è¯­**ï¼šæœ¬æ–¹æ¡ˆæ—¨åœ¨æ„å»ºä¸€ä¸ªæ—¢æœ‰â€œæ³•åº¦â€åˆæœ‰â€œæ¸©åº¦â€çš„æœå»·æ¶æ„ã€‚é€šè¿‡åˆ†çº§é—¸é—¨ï¼Œæˆ‘ä»¬æ—¢ä¿ç•™äº†å²å®˜ç”Ÿæ€äºˆå¤ºçš„å¨ä¸¥ï¼ˆé«˜å±åŒæ­¥ï¼‰ï¼Œåˆèµ‹äºˆäº†å…¶æ¶¦ç‰©ç»†æ— å£°çš„æ™ºæ…§ï¼ˆä½å±å¼‚æ­¥ï¼‰ï¼Œæœ€ç»ˆå®ç°ç³»ç»Ÿå®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒçš„æœ€ä½³å¹³è¡¡ã€‚
